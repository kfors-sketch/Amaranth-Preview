<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Thank You for Your Order</title>
  <link rel="stylesheet" href="/assets/css/styles.css" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f7f7fb;color:#111;margin:0}
    .container{max-width:720px;margin:32px auto;padding:0 16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:18px}
    .muted{color:#6b7280}
    .btn{height:40px;border:1px solid #d1d5db;background:#111;color:#fff;border-radius:10px;padding:0 14px;font-weight:700;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;justify-content:center}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:space-between}
    .val{font-weight:700}
    table{width:100%;border-collapse:collapse;margin-top:16px}
    th,td{padding:8px;border-bottom:1px solid #e5e7eb;text-align:left}
    th{text-align:left;background:#f9fafb}
    .ok{color:#065f46;font-weight:700}
    .warn{color:#92400e}
    .err{color:#b91c1c}
  </style>
</head>
<body>
  <main class="container">
    <div class="card">
      <h1 style="margin:0 0 8px">Thank you for your order!</h1>
      <div class="muted" id="status">Finalizing your receipt…</div>

      <div id="details" style="margin-top:14px;display:none">
        <div class="row"><div>Order #</div><div class="val" id="ordId">—</div></div>
        <div class="row"><div>Paid</div><div class="val" id="paid">$0.00</div></div>
        <div class="row"><div>Email</div><div class="val" id="email">—</div></div>

        <table id="orderTable" style="display:none">
          <thead>
            <tr><th>Item</th><th>Qty</th><th style="text-align:right">Price</th><th style="text-align:right">Line</th></tr>
          </thead>
          <tbody id="orderLines"></tbody>
          <tfoot>
            <tr>
              <td colspan="3" style="text-align:right;font-weight:700">Total</td>
              <td id="orderTotal" style="font-weight:700;text-align:right">$0.00</td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div style="margin-top:16px;display:flex;gap:10px;flex-wrap:wrap">
        <a class="btn" href="/home.html">Back to Home</a>
        <a class="btn" href="/order.html" id="newOrderBtn">New Order</a>
      </div>
    </div>
  </main>

  <script>
  (async function(){
    const q = new URLSearchParams(location.search);
    const sid = q.get('sid') || q.get('session_id'); // Stripe appends either
    const $ = (id)=>document.getElementById(id);
    const money = (c)=> (Number(c||0)/100).toLocaleString(undefined,{style:'currency',currency:'USD'});

    // Clear cart and notify other tabs
    try {
      if (window.Cart && Cart.clear) Cart.clear();
      localStorage.removeItem('amaranth_cart');
      localStorage.setItem('amaranth_cart_ping', String(Date.now()));
    } catch(e){}

    const statusEl = $('status');
    const detailsEl = $('details');
    const ordIdEl = $('ordId');
    const paidEl = $('paid');
    const emailEl = $('email');
    const tableEl = $('orderTable');
    const linesEl = $('orderLines');
    const totalEl = $('orderTotal');

    if (!sid) {
      statusEl.innerHTML = '<span class="warn">Payment completed, but no session id was provided.</span>';
      return;
    }

    // 1) Ask server to save the order (idempotent). This covers "no webhook" cases.
    try {
      const fin = await fetch('/api/router?type=finalize_order&sid=' + encodeURIComponent(sid), { cache: 'no-store' });
      if (fin.ok) {
        const j = await fin.json();
        if (j?.ok) statusEl.innerHTML = '<span class="ok">Payment confirmed. Receipt saved.</span>';
        else statusEl.innerHTML = '<span class="warn">Payment confirmed. Finalize pending…</span>';
      } else {
        statusEl.innerHTML = '<span class="warn">Payment confirmed. Finalize skipped.</span>';
      }
    } catch {
      statusEl.innerHTML = '<span class="warn">Payment confirmed. Finalize unavailable.</span>';
    }

    // Helper: render from a saved order object
    function renderFromOrder(order) {
      detailsEl.style.display = 'block';
      ordIdEl.textContent = order.id || sid;
      paidEl.textContent = money(order.amount_total || 0);
      emailEl.textContent = (order.customer_email || '—');

      const lines = Array.isArray(order.lines) ? order.lines : [];
      if (lines.length) {
        linesEl.innerHTML = lines.map(li => {
          const lineTotal = Number(li.unitPrice||0) * Number(li.qty||1);
          const notes = (li.category === 'banquet')
            ? (li.meta?.attendeeNotes || '')
            : (li.meta?.itemNote || '');
          const notesHtml = notes ? `<div style="font-size:12px;color:#444;margin-top:2px">Notes: ${String(notes).replace(/</g,'&lt;')}</div>` : '';
          return `<tr>
            <td>${(li.itemName||'')}${notesHtml}</td>
            <td>${Number(li.qty||1)}</td>
            <td style="text-align:right">${money(li.unitPrice||0)}</td>
            <td style="text-align:right">${money(lineTotal)}</td>
          </tr>`;
        }).join('');
        totalEl.textContent = money(order.amount_total || lines.reduce((s,li)=> s + Number(li.unitPrice||0)*Number(li.qty||1), 0));
        tableEl.style.display = 'table';
      }
    }

    // 2) Try reading the saved order directly
    let haveRendered = false;
    try {
      const o = await fetch('/api/router?type=order&oid=' + encodeURIComponent(sid), { cache: 'no-store' });
      if (o.ok) {
        const j = await o.json();
        if (j?.order) { renderFromOrder(j.order); haveRendered = true; }
      }
    } catch {}

    if (haveRendered) return;

    // 3) Fallback: read session basics + flattened rows (legacy)
    try {
      const sessResp = await fetch('/api/router?type=checkout_session&id=' + encodeURIComponent(sid), { cache: 'no-store' });
      const sess = await sessResp.json();
      if (!sess?.id) throw new Error();

      statusEl.innerHTML = '<span class="ok">Payment confirmed.</span>';
      detailsEl.style.display = 'block';
      ordIdEl.textContent = sess.id;
      paidEl.textContent = ( (sess.amount_total||0) / 100 ).toLocaleString(undefined,{style:'currency',currency:'USD'});
      emailEl.textContent = (sess.customer_details?.email || '—');

      const rowsResp = await fetch('/api/router?type=orders', { cache: 'no-store' });
      const rowsJ = await rowsResp.json();
      const rows = (rowsJ?.rows || []).filter(r => r.id === sess.id);

      if (rows.length) {
        linesEl.innerHTML = rows.map(r =>
          `<tr><td>${r.item}</td><td>${r.qty}</td><td style="text-align:right">$${Number(r.price||0).toFixed(2)}</td><td style="text-align:right">$${Number(r.gross||0).toFixed(2)}</td></tr>`
        ).join('');
        totalEl.textContent = ( (sess.amount_total||0) / 100 ).toLocaleString(undefined,{style:'currency',currency:'USD'});
        tableEl.style.display = 'table';
      }
    } catch {
      // As a last resort just leave the top summary; user still sees Order # and Paid.
      statusEl.innerHTML += '';
    }
  })();
  </script>
</body>
</html>