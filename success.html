<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Thank You for Your Order</title>
  <link rel="stylesheet" href="/assets/css/styles.css" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f7f7fb;color:#111;margin:0}
    .container{max-width:720px;margin:32px auto;padding:0 16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:18px}
    .muted{color:#6b7280}
    .btn{height:40px;border:1px solid #d1d5db;background:#111;color:#fff;border-radius:10px;padding:0 14px;font-weight:700;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;justify-content:center}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:space-between}
    .val{font-weight:700}
    table{width:100%;border-collapse:collapse;margin-top:16px}
    th,td{padding:8px;border-bottom:1px solid #e5e7eb;text-align:left}
    th{text-align:left;background:#f9fafb}
  </style>
</head>
<body>
  <main class="container">
    <div class="card">
      <h1 style="margin:0 0 8px">Thank you for your order!</h1>
      <div class="muted" id="status">Finalizing your receipt…</div>

      <div id="details" style="margin-top:14px;display:none">
        <div class="row"><div>Order #</div><div class="val" id="ordId">—</div></div>
        <div class="row"><div>Paid</div><div class="val" id="paid">$0.00</div></div>
        <div class="row"><div>Email</div><div class="val" id="email">—</div></div>

        <table id="orderTable" style="display:none">
          <thead>
            <tr><th>Item</th><th>Qty</th><th>Price</th><th>Line</th></tr>
          </thead>
          <tbody id="orderLines"></tbody>
          <tfoot>
            <tr>
              <td colspan="3" style="text-align:right;font-weight:700">Total</td>
              <td id="orderTotal" style="font-weight:700;text-align:right">$0.00</td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div style="margin-top:16px;display:flex;gap:10px">
        <a class="btn" href="/home.html">Back to Home</a>
        <a class="btn" href="/order.html">New Order</a>
      </div>
    </div>
  </main>

  <script>
  (function(){
    const q = new URLSearchParams(location.search);
    const sid = q.get('sid') || q.get('session_id');

    // Clear cart and notify other tabs
    try {
      if (window.Cart && Cart.clear) Cart.clear();
      localStorage.removeItem('amaranth_cart');
      localStorage.setItem('amaranth_cart_ping', String(Date.now()));
    } catch(e){}

    const status = document.getElementById('status');
    const details = document.getElementById('details');

    if (!sid) {
      status.textContent = 'Payment completed, but no session id was provided.';
      return;
    }

    fetch('/api/router?type=checkout_session&id='+encodeURIComponent(sid))
      .then(r => r.json())
      .then(j => {
        if (j && j.id) {
          status.textContent = 'Payment confirmed.';
          details.style.display = 'block';
          document.getElementById('ordId').textContent = j.id;
          const total = (j.amount_total||0)/100;
          document.getElementById('paid').textContent = total.toLocaleString(undefined,{style:'currency',currency:'USD'});
          document.getElementById('email').textContent = j.customer_details?.email || '—';

          // Try to load full order details (if stored in KV)
          fetch('/api/router?type=orders')
            .then(r=>r.json())
            .then(o=>{
              const rows = o?.rows?.filter(r=>r.id===j.id) || [];
              if (rows.length) {
                const tbody = document.getElementById('orderLines');
                tbody.innerHTML = rows.map(r=>
                  `<tr><td>${r.item}</td><td>${r.qty}</td><td style="text-align:right">$${r.price.toFixed(2)}</td><td style="text-align:right">$${r.gross.toFixed(2)}</td></tr>`
                ).join('');
                document.getElementById('orderTotal').textContent = total.toLocaleString(undefined,{style:'currency',currency:'USD'});
                document.getElementById('orderTable').style.display = 'table';
              }
            });
        } else {
          status.textContent = (j && j.error) ? j.error : 'Could not load receipt.';
        }
      })
      .catch(()=>{
        status.textContent = 'Could not load receipt.';
      });
  })();
  </script>
</body>
</html>
