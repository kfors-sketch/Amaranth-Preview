<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Thank You for Your Order</title>
  <link rel="stylesheet" href="/assets/css/styles.css" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f7f7fb;color:#111;margin:0}
    .container{max-width:720px;margin:32px auto;padding:0 16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:18px}
    .muted{color:#6b7280}
    .btn{height:40px;border:1px solid #d1d5db;background:#111;color:#fff;border-radius:10px;padding:0 14px;font-weight:700;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;justify-content:center}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:space-between}
    .val{font-weight:700}
    table{width:100%;border-collapse:collapse;margin-top:16px}
    th,td{padding:8px;border-bottom:1px solid #e5e7eb;text-align:left}
    th{text-align:left;background:#f9fafb}
    .ok{color:#065f46;font-weight:700}
    .warn{color:#92400e}
    .err{color:#b91c1c}
  </style>
</head>
<body>
  <main class="container">
    <div class="card">
      <h1 style="margin:0 0 8px">Thank you for your order!</h1>
      <div class="muted" id="status">Finalizing your receipt…</div>

      <div id="details" style="margin-top:14px;display:none">
        <div class="row"><div>Order #</div><div class="val" id="ordId">—</div></div>
        <div class="row"><div>Paid</div><div class="val" id="paid">$0.00</div></div>
        <div class="row"><div>Email</div><div class="val" id="email">—</div></div>

        <table id="orderTable" style="display:none">
          <thead>
            <tr><th>Item</th><th>Qty</th><th style="text-align:right">Price</th><th style="text-align:right">Line</th></tr>
          </thead>
          <tbody id="orderLines"></tbody>
          <tfoot>
            <tr>
              <td colspan="3" style="text-align:right;font-weight:700">Total</td>
              <td id="orderTotal" style="font-weight:700;text-align:right">$0.00</td>
            </tr>
          </tfoot>
        </table>

        <div id="attendeeBlock" style="margin-top:14px;display:none"></div>
      </div>

      <div style="margin-top:16px;display:flex;gap:10px;flex-wrap:wrap">
        <a class="btn" href="/home.html">Back to Home</a>
        <a class="btn" href="/order.html" id="newOrderBtn">New Order</a>
      </div>
    </div>
  </main>

  <script>
  (function(){
    const q = new URLSearchParams(location.search);
    const sid = q.get('sid') || q.get('session_id');
    const nowTs = () => Date.now();

    // Clear cart and notify other tabs
    try {
      if (window.Cart && Cart.clear) Cart.clear();
      localStorage.removeItem('amaranth_cart');
      localStorage.setItem('amaranth_cart_ping', String(Date.now()));
    } catch(e){}

    const status  = document.getElementById('status');
    const details = document.getElementById('details');

    if (!sid) {
      status.textContent = 'Payment completed, but no session id was provided.';
      return;
    }

    // ---- 1) Finalize (SAVES the order + sends emails)
    fetch('/api/router?action=finalize_checkout', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ sid })
    })
    .then(r => r.json())
    .then(async (j) => {
      if (!j || j.error) {
        status.textContent = (j && j.error) ? j.error : 'Could not finalize order.';
        return;
      }

      // Capture any order payload returned by finalize_checkout (sometimes richer than /type=order)
      const orderFromFinalize = (j && (j.order || (j.data && j.data.order) || j.savedOrder || j.payload && j.payload.order)) || null;

      // Belt & suspenders: idempotent GET finalize in case POST had any hiccup.
      fetch('/api/router?type=finalize_order&sid=' + encodeURIComponent(sid) + '&t=' + nowTs(), { cache: 'no-store' })
        .catch(()=>{ /* safe to ignore */ });

      // ---- 2) Show confirmation basics using Stripe session data
      try {
        const sessResp = await fetch(
          '/api/router?type=checkout_session&id=' + encodeURIComponent(sid) + '&t=' + nowTs(),
          { cache: 'no-store' }
        );
        const s = await sessResp.json().catch(()=>null);

        if (s && s.id) {
          status.textContent = 'Payment confirmed.';
          details.style.display = 'block';
          document.getElementById('ordId').textContent = s.id;
          const total = (s.amount_total||0)/100;
          document.getElementById('paid').textContent =
            total.toLocaleString(undefined,{style:'currency',currency:'USD'});
          document.getElementById('email').textContent = (s.customer_details && s.customer_details.email) || '—';
          document.getElementById('orderTotal').textContent =
            total.toLocaleString(undefined,{style:'currency',currency:'USD'});
        } else {
          status.textContent = 'Payment confirmed.';
        }
      } catch(_) {
        status.textContent = 'Payment confirmed.';
      }

      // ---- 3) Try to load the single saved order (UNWRAP the { order } shape)
      let rows = [];
      try {
        const orderResp = await fetch(
          '/api/router?type=order&oid=' + encodeURIComponent(sid) + '&t=' + nowTs(),
          { cache: 'no-store' }
        );
        const orderJson = await orderResp.json().catch(()=>null);
        const ord = (orderJson && orderJson.order ? orderJson.order : null) || orderFromFinalize;

        if (ord && Array.isArray(ord.lines)) {
          rows = ord.lines.map(li => ({
            item: li.itemName,
            qty: li.qty,
            price: (li.unitPrice || 0)/100,
            gross: (li.gross || (li.qty||1)*(li.unitPrice||0))/100,
            note: (li.note || li.notes || li.attendeeNote || li.specialInstructions || (li.meta && (li.meta.note || li.meta.notes))) || ''
          }));
          const orderTotal = rows.reduce((s,r)=> s + Number(r.gross||0), 0);
          document.getElementById('orderTotal').textContent =
            orderTotal.toLocaleString(undefined,{style:'currency',currency:'USD'});
        }
      } catch(_) { /* fall through to list */ }

      // Fallback: scan the rows list for this sid
      if (!rows.length) {
        const listResp = await fetch(
          '/api/router?type=orders&t=' + nowTs(),
          { cache: 'no-store' }
        ).catch(()=>null);
        const all = listResp ? await listResp.json().catch(()=>null) : null;
        rows = (all && Array.isArray(all.rows) ? all.rows : []).filter(r => r.id === sid);
      }

      // Render lines if present
      if (rows.length) {
        const tbody = document.getElementById('orderLines');
        const esc = (s) => String(s ?? '')
          .replaceAll('&','&amp;').replaceAll('<','&lt;')
          .replaceAll('>','&gt;').replaceAll('"','&quot;')
          .replaceAll("'",'&#39;');

        tbody.innerHTML = rows.map(r => {
          const noteHtml = r.note ? `<div class="muted" style="margin-top:4px;font-size:12px"><b>Note:</b> ${esc(r.note)}</div>` : '';
          return `<tr>
            <td>${esc(r.item)}${noteHtml}</td>
            <td>${esc(r.qty)}</td>
            <td style="text-align:right">$${Number(r.price||0).toFixed(2)}</td>
            <td style="text-align:right">$${Number(r.gross||0).toFixed(2)}</td>
          </tr>`;
        }).join('');
        document.getElementById('orderTable').style.display = 'table';

        // ---- Attendee breakdown (uses richer order shapes; falls back to showing notes-only if no attendee linkage)
        try {
          const ordForAtt = (orderFromFinalize || null);
          const ordObj = (typeof ord !== 'undefined' && ord) ? ord : ordForAtt;
          const block = document.getElementById('attendeeBlock');
          if (block && ordObj) {
            const norm = (s) => String(s||'').toLowerCase().replace(/\s+/g,' ').trim();

            // Map attendeeId -> name if present
            const attendeeNameById = new Map();
            if (Array.isArray(ordObj.attendees)) {
              ordObj.attendees.forEach(a => {
                const id = a && (a.id || a.attendeeId || a.attendee_id);
                const nm = a && (a.name || a.attendeeName || a.displayName);
                if (id && nm) attendeeNameById.set(String(id), String(nm));
              });
            }

            const resolveAttendee = (o) => {
              if (!o) return '';
              const id = o.attendeeId || o.attendee_id || o.personId || o.person_id;
              if (id && attendeeNameById.has(String(id))) return attendeeNameById.get(String(id));
              return o.attendeeName || o.attendee || o.name || o.personName || o.person || '';
            };
            const getLabel = (o) => {
              if (!o) return '';
              const base = o.title || o.itemName || o.name || o.label || o.productName || '';
              const opt  = o.entree || o.option || o.variant || o.choice || '';
              return opt ? `${base} (${opt})` : base;
            };
            const getNote = (o) => (o && (o.note || o.notes || o.attendeeNote || o.specialInstructions || (o.meta && (o.meta.note || o.meta.notes)))) || '';

            const groups = new Map(); // key -> { name, items: [] }
            const ensure = (name) => {
              const key = norm(name) || 'attendee';
              const display = String(name||'Attendee').trim() || 'Attendee';
              if (!groups.has(key)) groups.set(key, { name: display, items: [] });
              return groups.get(key);
            };
            const addItem = (attendeeName, label, note, qty) => {
              const g = ensure(attendeeName);
              g.items.push({ label, note, qty: qty || 1 });
            };
            const scanArray = (arr) => {
              if (!Array.isArray(arr)) return;
              arr.forEach(o => {
                const who = resolveAttendee(o);
                const label = getLabel(o);
                const note = getNote(o);
                const qty = o.qty || o.quantity || 1;
                if (who && label) addItem(who, label, note, qty);
              });
            };

            // Common order sections
            scanArray(ordObj.banquets);
            scanArray(ordObj.addons);
            scanArray(ordObj.catalog);
            scanArray(ordObj.products);
            scanArray(ordObj.items);

            // Attendee nested sections
            if (Array.isArray(ordObj.attendees)) {
              ordObj.attendees.forEach(a => {
                const who = a && (a.name || a.attendeeName || a.displayName);
                if (!who) return;
                scanArray(a.banquets);
                scanArray(a.addons);
                scanArray(a.items);
              });
            }

            // If still no attendee linkage but we have notes on rows, show a simple "Notes" section
            const notesOnly = rows.filter(r => r.note).map(r => ({ label: r.item, note: r.note, qty: r.qty || 1 }));
            if (!groups.size && notesOnly.length) {
              const g = ensure('Order Notes');
              notesOnly.forEach(x => g.items.push(x));
            }

            if (groups.size) {
              block.style.display = 'block';
              const cards = Array.from(groups.values()).map(g => {
                const lis = g.items.map(it => {
                  const q = it.qty && Number(it.qty) !== 1 ? ` × ${esc(it.qty)}` : '';
                  const n = it.note ? `<div class="muted" style="margin-top:2px;font-size:12px"><b>Note:</b> ${esc(it.note)}</div>` : '';
                  return `<li style="margin:8px 0"><div><b>${esc(it.label)}</b>${q}</div>${n}</li>`;
                }).join('');
                return `<div style="border:1px solid #e5e7eb;border-radius:12px;padding:12px;margin-top:10px">
                  <div style="font-weight:800">${esc(g.name)}</div>
                  <ul style="margin:8px 0 0 18px;padding:0">${lis}</ul>
                </div>`;
              }).join('');

              block.innerHTML = `<h3 style="margin:16px 0 6px">Attendee details</h3>
                <div class="muted" style="font-size:12px;margin-bottom:8px">What each attendee ordered (with notes).</div>
                ${cards}`;
            }
          }
        } catch(e) { /* ignore */ }
      }
    })
    .catch(()=>{
      status.textContent = 'Could not finalize order.';
    });
  })();
  </script>
</body>
</html>
