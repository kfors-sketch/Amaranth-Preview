<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Thank You for Your Order</title>
  <link rel="stylesheet" href="/assets/css/styles.css" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f7f7fb;color:#111;margin:0}
    .container{max-width:720px;margin:32px auto;padding:0 16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:18px}
    .muted{color:#6b7280}
    .btn{height:40px;border:1px solid #d1d5db;background:#111;color:#fff;border-radius:10px;padding:0 14px;font-weight:700;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;justify-content:center}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:space-between}
    .val{font-weight:700}
    table{width:100%;border-collapse:collapse;margin-top:16px}
    th,td{padding:8px;border-bottom:1px solid #e5e7eb;text-align:left}
    th{text-align:left;background:#f9fafb}
    .ok{color:#065f46;font-weight:700}
    .warn{color:#92400e}
    .err{color:#b91c1c}
  </style>
</head>
<body>
  <main class="container">
    <div class="card">
      <h1 style="margin:0 0 8px">Thank you for your order!</h1>
      <div class="muted" id="status">Finalizing your receipt…</div>

      <div id="details" style="margin-top:14px;display:none">
        <div class="row"><div>Order #</div><div class="val" id="ordId">—</div></div>
        <div class="row"><div>Paid</div><div class="val" id="paid">$0.00</div></div>
        <div class="row"><div>Email</div><div class="val" id="email">—</div></div>

        <table id="orderTable" style="display:none">
          <thead>
            <tr><th>Item</th><th>Qty</th><th style="text-align:right">Price</th><th style="text-align:right">Line</th></tr>
          </thead>
          <tbody id="orderLines"></tbody>
          <tfoot>
            <tr>
              <td colspan="3" style="text-align:right;font-weight:700">Total</td>
              <td id="orderTotal" style="font-weight:700;text-align:right">$0.00</td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div style="margin-top:16px;display:flex;gap:10px;flex-wrap:wrap">
        <a class="btn" href="/home.html">Back to Home</a>
        <a class="btn" href="/order.html" id="newOrderBtn">New Order</a>
      </div>
    </div>
  </main>

  <script>
  (function(){
    const q = new URLSearchParams(location.search);
    const sid = q.get('sid') || q.get('session_id');

    // Clear cart and notify other tabs
    try {
      if (window.Cart && Cart.clear) Cart.clear();
      localStorage.removeItem('amaranth_cart');
      localStorage.setItem('amaranth_cart_ping', String(Date.now()));
    } catch(e){}

    const status  = document.getElementById('status');
    const details = document.getElementById('details');

    if (!sid) {
      status.textContent = 'Payment completed, but no session id was provided.';
      return;
    }

    // 1) Finalize (SAVES the order + sends emails) — THIS is the important call
    fetch('/api/router?action=finalize_checkout', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ sid })
    })
    .then(r => r.json())
    .then(async (j) => {
      if (!j || j.error) {
        status.textContent = (j && j.error) ? j.error : 'Could not finalize order.';
        return;
      }

      // 2) Show confirmation basics using Stripe session data
      const sessResp = await fetch('/api/router?type=checkout_session&id=' + encodeURIComponent(sid));
      const s = await sessResp.json().catch(()=>null);

      if (s && s.id) {
        status.textContent = 'Payment confirmed.';
        details.style.display = 'block';
        document.getElementById('ordId').textContent = s.id;
        const total = (s.amount_total||0)/100;
        document.getElementById('paid').textContent =
          total.toLocaleString(undefined,{style:'currency',currency:'USD'});
        document.getElementById('email').textContent = s.customer_details?.email || '—';
      } else {
        status.textContent = 'Payment confirmed.';
      }

      // 3) Try to load the single saved order (more reliable than pulling the whole list)
      const orderResp = await fetch('/api/router?type=order&oid=' + encodeURIComponent(sid));
      const order = await orderResp.json().catch(()=>null);

      // Fallback: if single order isn’t available yet, try the rows list (optional)
      let rows = [];
      if (order && order.lines) {
        // adapt order to rows-like for the table
        rows = (order.lines || []).map(li => ({
          item: li.itemName,
          qty: li.qty,
          price: (li.unitPrice || 0)/100,
          gross: (li.gross || (li.qty||1)*(li.unitPrice||0))/100
        }));
      } else {
        const all = await fetch('/api/router?type=orders').then(r=>r.json()).catch(()=>null);
        rows = (all?.rows || []).filter(r => r.id === sid);
      }

      if (rows.length) {
        const tbody = document.getElementById('orderLines');
        tbody.innerHTML = rows.map(r =>
          `<tr>
            <td>${r.item}</td>
            <td>${r.qty}</td>
            <td style="text-align:right">$${Number(r.price||0).toFixed(2)}</td>
            <td style="text-align:right">$${Number(r.gross||0).toFixed(2)}</td>
          </tr>`
        ).join('');
        document.getElementById('orderTable').style.display = 'table';
      }
    })
    .catch(()=>{
      status.textContent = 'Could not finalize order.';
    });
  })();
  </script>
</body>
</html>
