<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Thank You for Your Order</title>
  <link rel="stylesheet" href="/assets/css/styles.css" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f7f7fb;color:#111;margin:0}
    .container{max-width:720px;margin:32px auto;padding:0 16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:18px}
    .muted{color:#6b7280}
    .btn{height:40px;border:1px solid #d1d5db;background:#111;color:#fff;border-radius:10px;padding:0 14px;font-weight:700;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;justify-content:center}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:space-between}
    .val{font-weight:700}
    table{width:100%;border-collapse:collapse;margin-top:16px}
    th,td{padding:8px;border-bottom:1px solid #e5e7eb;text-align:left}
    th{text-align:left;background:#f9fafb}
    .ok{color:#065f46;font-weight:700}
    .warn{color:#92400e}
    .err{color:#b91c1c}
  </style>
</head>
<body>
  <main class="container">
    <div class="card">
      <h1 style="margin:0 0 8px">Thank you for your order!</h1>
      <div class="muted" id="status">Finalizing your receipt…</div>

      <div id="details" style="margin-top:14px;display:none">
        <div class="row"><div>Order #</div><div class="val" id="ordId">—</div></div>
        <div class="row"><div>Paid</div><div class="val" id="paid">$0.00</div></div>
        <div class="row"><div>Email</div><div class="val" id="email">—</div></div>

        <table id="orderTable" style="display:none">
          <thead>
            <tr><th>Item</th><th>Qty</th><th style="text-align:right">Price</th><th style="text-align:right">Line</th></tr>
          </thead>
          <tbody id="orderLines"></tbody>
          <tfoot>
            <tr>
              <td colspan="3" style="text-align:right;font-weight:700">Total</td>
              <td id="orderTotal" style="font-weight:700;text-align:right">$0.00</td>
            </tr>
          </tfoot>
        </table>

        <div id="attendeeBlock" style="margin-top:14px;display:none"></div>
      </div>

      <div style="margin-top:16px;display:flex;gap:10px;flex-wrap:wrap">
        <a class="btn" href="/home.html">Back to Home</a>
        <a class="btn" href="/order.html" id="newOrderBtn">New Order</a>
      </div>
    </div>
  </main>

  <script>
  (function(){
    const q = new URLSearchParams(location.search);
    const sid = q.get('sid') || q.get('session_id');
    const nowTs = () => Date.now();

    // Clear cart and notify other tabs
    try {
      if (window.Cart && Cart.clear) Cart.clear();
      localStorage.removeItem('amaranth_cart');
      localStorage.setItem('amaranth_cart_ping', String(Date.now()));
    } catch(e){}

    const status  = document.getElementById('status');
    const details = document.getElementById('details');

    if (!sid) {
      status.textContent = 'Payment completed, but no session id was provided.';
      return;
    }

    // ---- 1) Finalize (SAVES the order + sends emails)
    fetch('/api/router?action=finalize_checkout', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ sid })
    })
    .then(r => r.json())
    .then(async (j) => {
      if (!j || j.error) {
        status.textContent = (j && j.error) ? j.error : 'Could not finalize order.';
        return;
      }

      // Belt & suspenders: idempotent GET finalize in case POST had any hiccup.
      fetch('/api/router?type=finalize_order&sid=' + encodeURIComponent(sid) + '&t=' + nowTs(), { cache: 'no-store' })
        .catch(()=>{ /* safe to ignore */ });

      // ---- 2) Show confirmation basics using Stripe session data
      try {
        const sessResp = await fetch(
          '/api/router?type=checkout_session&id=' + encodeURIComponent(sid) + '&t=' + nowTs(),
          { cache: 'no-store' }
        );
        const s = await sessResp.json().catch(()=>null);

        if (s && s.id) {
          status.textContent = 'Payment confirmed.';
          details.style.display = 'block';
          document.getElementById('ordId').textContent = s.id;
          const total = (s.amount_total||0)/100;
          document.getElementById('paid').textContent =
            total.toLocaleString(undefined,{style:'currency',currency:'USD'});
          document.getElementById('email').textContent = (s.customer_details && s.customer_details.email) || '—';
          document.getElementById('orderTotal').textContent =
            total.toLocaleString(undefined,{style:'currency',currency:'USD'});
        } else {
          status.textContent = 'Payment confirmed.';
        }
      } catch(_) {
        status.textContent = 'Payment confirmed.';
      }

      // ---- 3) Try to load the single saved order (UNWRAP the { order } shape)
      let rows = [];
      let attendeeGroups = null;
      try {
        const orderResp = await fetch(
          '/api/router?type=order&oid=' + encodeURIComponent(sid) + '&t=' + nowTs(),
          { cache: 'no-store' }
        );
        const orderJson = await orderResp.json().catch(()=>null);
        const ord = orderJson && orderJson.order ? orderJson.order : null;

        if (ord && Array.isArray(ord.lines)) {
          // ---- Build attendee breakdown from the saved order (not from Stripe line items)
          const norm = (s) => String(s||'').toLowerCase().replace(/\s+/g,' ').trim();

          const groups = new Map(); // name -> { name, items: [] }
          const ensure = (name) => {
            const n = norm(name) || 'attendee';
            const display = String(name||'Attendee').trim() || 'Attendee';
            if (!groups.has(n)) groups.set(n, { name: display, items: [] });
            return groups.get(n);
          };
          const addItem = (attendeeName, label, note, qty) => {
            if (!label) return;
            const g = ensure(attendeeName);
            g.items.push({
              label: String(label),
              note: note ? String(note) : '',
              qty: qty && Number(qty) ? Number(qty) : 1
            });
          };

          // Build quick attendee lookup by id if present
          const attendeeNameById = new Map();
          if (Array.isArray(ord.attendees)) {
            ord.attendees.forEach(a => {
              const id = a && (a.id || a.attendeeId || a.key);
              const nm = a && (a.name || a.attendeeName || a.displayName);
              if (id && nm) attendeeNameById.set(String(id), String(nm));
            });
          }
          const resolveAttendee = (o) => {
            if (!o) return '';
            const id = o.attendeeId || o.attendee_id || o.personId || o.person_id;
            if (id && attendeeNameById.has(String(id))) return attendeeNameById.get(String(id));
            return o.attendeeName || o.attendee || o.name || o.personName || o.person || '';
          };

          const getLabel = (o) => {
            if (!o) return '';
            const base = o.title || o.itemName || o.name || o.label || o.productName || '';
            const opt  = o.entree || o.option || o.variant || o.choice || '';
            return opt ? `${base} (${opt})` : base;
          };
          const getNote = (o) => (o && (o.note || o.notes || o.attendeeNote || o.specialInstructions || (o.meta && (o.meta.note || o.meta.notes)) )) || '';

          const scanArray = (arr) => {
            if (!Array.isArray(arr)) return;
            arr.forEach(o => {
              const who = resolveAttendee(o);
              const label = getLabel(o);
              const note = getNote(o);
              const qty = o.qty || o.quantity || 1;
              if (who && label) addItem(who, label, note, qty);
            });
          };

          // Common order sections
          scanArray(ord.banquets);
          scanArray(ord.addons);
          scanArray(ord.catalog);
          scanArray(ord.products);
          scanArray(ord.items);

          // Attendee nested sections (if your structure is attendee-centric)
          if (Array.isArray(ord.attendees)) {
            ord.attendees.forEach(a => {
              const who = a && (a.name || a.attendeeName || a.displayName);
              if (!who) return;
              scanArray(a.banquets);
              scanArray(a.addons);
              scanArray(a.items);
              scanArray(a.orders);
            });
          }

          // If nothing matched but we DO have multiple attendees, at least show attendee names
          if (!groups.size && Array.isArray(ord.attendees) && ord.attendees.length) {
            ord.attendees.forEach(a => {
              const who = a && (a.name || a.attendeeName || a.displayName);
              if (who) ensure(who);
            });
          }

          attendeeGroups = Array.from(groups.values())
            .map(g => ({ name: g.name, items: g.items }))
            .filter(g => g.name);

          // ---- Build rows for the summary table
          rows = ord.lines.map(li => ({
            item: li.itemName,
            qty: li.qty,
            price: (li.unitPrice || 0)/100,
            gross: (li.gross || (li.qty||1)*(li.unitPrice||0))/100
          }));

          const orderTotal = rows.reduce((s,r)=> s + Number(r.gross||0), 0);
          document.getElementById('orderTotal').textContent =
            orderTotal.toLocaleString(undefined,{style:'currency',currency:'USD'});
        }
      } catch(_) { /* fall through to list */ }

      // Fallback: scan the rows list for this sid
      if (!rows.length) {
        const listResp = await fetch(
          '/api/router?type=orders&t=' + nowTs(),
          { cache: 'no-store' }
        ).catch(()=>null);
        const all = listResp ? await listResp.json().catch(()=>null) : null;
        rows = (all && Array.isArray(all.rows) ? all.rows : []).filter(r => r.id === sid);
      }

      // Render lines if present
      if (rows.length) {
        const tbody = document.getElementById('orderLines');
        tbody.innerHTML = rows.map(r =>
          `<tr>
            <td>${r.item}</td>
            <td>${r.qty}</td>
            <td style="text-align:right">$${Number(r.price||0).toFixed(2)}</td>
            <td style="text-align:right">$${Number(r.gross||0).toFixed(2)}</td>
          </tr>`
        ).join('');
        document.getElementById('orderTable').style.display = 'table';
        // Render attendee breakdown if available
        try {
          if (attendeeGroups && attendeeGroups.length) {
            const block = document.getElementById('attendeeBlock');
            if (block) {
              const esc = (s) => String(s ?? '')
                .replaceAll('&','&amp;').replaceAll('<','&lt;')
                .replaceAll('>','&gt;').replaceAll('"','&quot;')
                .replaceAll("'",'&#39;');

              block.style.display = 'block';
              const cards = attendeeGroups.map(g => {
                const lines = (g.items && g.items.length)
                  ? g.items.map(it => `
                      <li style="margin:6px 0">
                        <div><b>${esc(it.label)}</b>${it.qty && it.qty !== 1 ? ` × ${esc(it.qty)}` : ''}</div>
                        ${it.note ? `<div class="muted" style="font-size:12px;margin-top:2px"><b>Note:</b> ${esc(it.note)}</div>` : ''}
                      </li>
                    `).join('')
                  : `<li class="muted" style="margin:6px 0">No attendee-specific items were recorded for this order.</li>`;

                return `
                  <div style="border:1px solid #e5e7eb;border-radius:12px;padding:12px;margin-top:10px">
                    <div style="font-weight:800">${esc(g.name)}</div>
                    <ul style="margin:8px 0 0 18px;padding:0">${lines}</ul>
                  </div>
                `;
              }).join('');

              block.innerHTML = `
                <h3 style="margin:16px 0 6px">Attendee details</h3>
                <div class="muted" style="font-size:12px;margin-bottom:8px">What each attendee ordered (with notes).</div>
                ${cards}
              `;
            }
          }
        } catch(e) { /* ignore */ }

      }
    })
    .catch(()=>{
      status.textContent = 'Could not finalize order.';
    });
  })();
  </script>
</body>
</html>
