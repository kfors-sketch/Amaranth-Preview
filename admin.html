<!doctype html>
<html lang="en"><head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin</title>
  <link rel="stylesheet" href="/assets/css/styles.css">
  <style>
    .panel{background:rgba(255,255,255,.85);padding:12px;border-radius:10px;border:1px solid #ddd;margin:10px 0}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
    .tabs button{padding:6px 10px;border-radius:8px;border:1px solid #aaa;background:#fff;cursor:pointer}
    .tabs button.active{background:#222;color:#fff;border-color:#222}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
    .card{background:#fff;border:1px solid #ddd;border-radius:10px;padding:10px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input[type="text"], input[type="number"]{padding:6px;border:1px solid #ccc;border-radius:8px;width:100%}
    label{display:block;font-size:.9em;margin:4px 0}
    .small{font-size:.85em;color:#555}.mt{margin-top:8px}.success{background:#0a7b2d;color:#fff;border:none;padding:6px 10px;border-radius:8px}
  </style>
</head>
<body>
  <div class="wallpaper"></div>
  <div class="page">
    <header class="site-header">
      <h1>Admin</h1>
      <nav class="site-nav">
        <a href="/home.html">Home</a>
        <a href="/product-catalog.html">Product Catalog</a>
        <a href="/banquet.html">Banquets</a>
        <a href="/order.html">Order</a>
      </nav>
    </header>
    <main>
      <div class="tabs">
        <button class="tab active" data-tab="settings">Settings</button>
        <button class="tab" data-tab="items">Items</button>
        <button class="tab" data-tab="banquets">Banquets</button>
        <button class="tab" data-tab="reports">Reports/Export</button>
      </div>

      <section class="panel tabpanel" id="tab-settings">
        <h2>Site Settings</h2>
        <div class="row">
          <label>Product Catalog Label <input id="set-label" type="text" placeholder="Product Catalog"></label>
          <label>Wallpaper URL <input id="set-wall" type="text" placeholder="/assets/img/wallpaper.jpg"></label>
        </div>
        <div class="row">
          <label>Fee Percent <input id="set-fee-p" type="number" step="0.1" placeholder="2.9"></label>
          <label>Fee Flat ($) <input id="set-fee-f" type="number" step="0.01" placeholder="0.30"></label>
        </div>
        <button id="saveSettings" class="success mt">Save Settings</button>
        <p class="small">Local preview only. Final Admin will use secure login + database.</p>
      </section>

      <section class="panel tabpanel" id="tab-items" style="display:none">
        <h2>Product Catalog Items</h2>
        <div id="items" class="grid"></div>
        <button id="addItem" class="mt">Add Item</button>
      </section>

      <section class="panel tabpanel" id="tab-banquets" style="display:none">
        <h2>Banquet & Grand Items</h2>
        <div id="banqs" class="grid"></div>
        <button id="addBanquet" class="mt">Add Banquet</button>
      </section>

      <section class="panel tabpanel" id="tab-reports" style="display:none">
        <h2>Reports & Export (Demo)</h2>
        <button id="exportCSV">Download Current Cart as CSV</button>
        <p class="small">Demo: exports current cart from this browser. Production reports will export paid orders and email chairs.</p>
      </section>
    </main>
  </div>

<!-- scripts -->
<script src="/assets/js/site-settings.js"></script>
<script src="/assets/js/items.js"></script>
<script src="/assets/js/banquets.js"></script>
<script src="/assets/js/data-store.js"></script>
<script src="/assets/js/cart.js"></script>
<script src="/assets/js/site-boot.js"></script>
<script>
// Tabs
document.querySelectorAll('.tab').forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.tabpanel').forEach(p=>p.style.display='none');
    document.getElementById('tab-'+btn.dataset.tab).style.display='block';
  };
});
// Settings
(function(){
  const s = DataStore.getSettings();
  const $ = id => document.getElementById(id);
  $('#set-label').value = s.productCatalogLabel || 'Product Catalog';
  $('#set-wall').value = s.wallpaperUrl || '';
  $('#set-fee-p').value = (typeof s.feePercent==='number') ? s.feePercent : (window.SITE_SETTINGS.feePercent||0);
  $('#set-fee-f').value = (typeof s.feeFlat==='number') ? s.feeFlat : (window.SITE_SETTINGS.feeFlat||0);
  document.getElementById('saveSettings').onclick = ()=>{
    DataStore.saveSettings({
      productCatalogLabel: $('#set-label').value.trim(),
      wallpaperUrl: $('#set-wall').value.trim(),
      feePercent: parseFloat($('#set-fee-p').value) || 0,
      feeFlat: parseFloat($('#set-fee-f').value) || 0
    });
    alert('Settings saved.');
  };
})();
// Items editor
(function(){
  const root = document.getElementById('items');
  function render(){
    const items = DataStore.getItems();
    root.innerHTML = items.map((it, idx)=>{
      const tiers = (it.tiered && it.pricing) ? it.pricing.map(p=>`${p.qty}:${p.price}`).join(', ') : '';
      return `<div class="card">
        <label>Name <input data-k="name" data-i="${idx}" type="text" value="${it.name||''}"></label>
        <label>ID <input data-k="id" data-i="${idx}" type="text" value="${it.id||''}"></label>
        <label>Active <input data-k="active" data-i="${idx}" type="checkbox" ${it.active!==false?'checked':''}></label>
        <label>Tiered <input data-k="tiered" data-i="${idx}" type="checkbox" ${it.tiered?'checked':''}></label>
        <div class="small">If tiered, set "Tier Pricing" as pairs "qty:price"</div>
        <label>Single Price <input data-k="price" data-i="${idx}" type="number" step="0.01" value="${it.price||0}"></label>
        <label>Tier Pricing <input data-k="pricing" data-i="${idx}" type="text" placeholder="1:10, 3:25, 10:75" value="${tiers}"></label>
      </div>`;
    }).join('');
    root.querySelectorAll('input').forEach(inp=>{
      inp.onchange=()=>{
        const items = DataStore.getItems();
        const i = parseInt(inp.dataset.i,10), k = inp.dataset.k;
        let v = inp.type==='checkbox' ? inp.checked : inp.value;
        if (k==='pricing'){
          v = (inp.value||'').split(',').map(t=>t.trim()).filter(Boolean).map(s=>{
            const [q,p] = s.split(':').map(x=>x.trim()); return {qty:parseInt(q||'0',10), price:parseFloat(p||'0')};
          }).filter(x=>x.qty>0 && !isNaN(x.price));
          items[i].tiered = true; items[i].pricing = v;
        } else if (k==='price'){ items[i][k] = parseFloat(v||'0')||0; }
        else if (k==='active' || k==='tiered'){ items[i][k] = !!v; }
        else { items[i][k] = v; }
        DataStore.saveItems(items); render();
      };
    });
  }
  render();
  document.getElementById('addItem').onclick=()=>{
    const items = DataStore.getItems();
    items.push({id:'new-item-'+(items.length+1), name:'New Item', tiered:false, price:0, active:true});
    DataStore.saveItems(items); render();
  };
  window.addEventListener('items:updated', render);
})();
// Banquets editor
(function(){
  const root = document.getElementById('banqs');
  function render(){
    const bq = DataStore.getBanquets();
    root.innerHTML = bq.map((b, idx)=>{
      const opts = (b.options||[]).map(o=>`${o.id}:${o.label}:${o.price}`).join(', ');
      return `<div class="card">
        <label>Name <input data-k="name" data-i="${idx}" type="text" value="${b.name||''}"></label>
        <label>ID <input data-k="id" data-i="${idx}" type="text" value="${b.id||''}"></label>
        <label>Date/Time <input data-k="datetime" data-i="${idx}" type="text" value="${b.datetime||''}"></label>
        <label>Description <input data-k="description" data-i="${idx}" type="text" value="${b.description||''}"></label>
        <label>Active <input data-k="active" data-i="${idx}" type="checkbox" ${b.active!==false?'checked':''}></label>
        <div class="small">Options as triples "id:label:price" separated by commas</div>
        <label>Options <input data-k="options" data-i="${idx}" type="text" placeholder="adult:Adult Ticket:60, child:Child Ticket:30" value="${opts}"></label>
      </div>`;
    }).join('');
    root.querySelectorAll('input').forEach(inp=>{
      inp.onchange=()=>{
        const bq = DataStore.getBanquets();
        const i = parseInt(inp.dataset.i,10), k = inp.dataset.k;
        let v = inp.type==='checkbox' ? inp.checked : inp.value;
        if (k==='options'){
          v = (inp.value||'').split(',').map(t=>t.trim()).filter(Boolean).map(s=>{
            const [id,label,price] = s.split(':');
            return {id:(id||'').trim(), label:(label||'').trim(), price: parseFloat((price||'0').trim())||0 };
          }).filter(x=>x.id && x.label);
          bq[i].options = v;
        } else if (k==='active'){ bq[i][k] = !!v; }
        else { bq[i][k] = v; }
        DataStore.saveBanquets(bq); render();
      };
    });
  }
  render();
  document.getElementById('addBanquet').onclick=()=>{
    const bq = DataStore.getBanquets();
    bq.push({id:'new-bq-'+(bq.length+1), name:'New Banquet', datetime:'', description:'', options:[{id:'adult',label:'Adult Ticket',price:0}], active:true});
    DataStore.saveBanquets(bq); render();
  };
  window.addEventListener('banquets:updated', render);
})();
// Export demo (current cart only)
(function(){
  function csvEscape(s){ s=(s||'')+''; if (s.includes(',')||s.includes('"')||s.includes('\\n')) s='"'+s.replace(/"/g,'""')+'"'; return s; }
  function download(name, text){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([text],{type:'text/csv'})); a.download=name; a.click(); }
  document.getElementById('exportCSV').onclick=()=>{
    Cart.load();
    const st = Cart.get();
    const rows = [['paid_at','attendee_name','attendee_email','attendee_title','item_name','qty','unit_price','line_total','diet_flags','diet_other','event_datetime']];
    st.lines.forEach(l=>{
      const a = st.attendees.find(x=>x.id===l.attendeeId)||{};
      const df=(l.meta&&l.meta.dietFlags)?l.meta.dietFlags.join(';'):''; const other=(l.meta&&l.meta.dietOther)||''; const ev=(l.meta&&l.meta.event)||'';
      rows.push(['',a.name||'',a.email||'',a.title||'',l.itemName||'',l.qty||0,l.unitPrice||0,(l.unitPrice||0)*(l.qty||0),df,other,ev]);
    });
    const csv = rows.map(r=>r.map(csvEscape).join(',')).join('\\n');
    download('cart_export.csv', csv);
  };
})();
</script>
</html>
