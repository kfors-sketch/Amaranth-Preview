<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin</title>
  <link rel="stylesheet" href="/assets/css/styles.css">
  <style>
    .panel{background:rgba(255,255,255,.85);padding:12px;border-radius:10px;border:1px solid #ddd;margin:10px 0}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:flex-end}
    label{display:flex;flex-direction:column;gap:6px;min-width:220px}
    input,select{padding:.55rem .7rem;border:1px solid #d1d5db;border-radius:.5rem;background:rgba(255,255,255,0.9)}
    .tiny{font-size:.85rem;color:#555}
    .status{margin-top:8px}
  </style>
</head>
<body>
  <div class="wallpaper"></div>
  <div class="page">
    <header class="site-header"><h1>Admin</h1></header>

    <main class="container">
      <!-- Site Settings (unchanged) -->
      <section class="panel">
        <h2>Site Settings</h2>
        <label>Product Catalog label <input id="label" value="Product Catalog"></label>
        <label>Fee % <input id="feePct" type="number" step="0.1" value="2.9"></label>
        <label>Fee flat <input id="feeFlat" type="number" step="0.01" value="0.30"></label>
        <button id="save">Save (local)</button>
        <p class="tiny">This is a preview Admin placeholder. In production we will wire secure login and a database.</p>
      </section>

      <!-- NEW: Reporting -->
      <section class="panel">
        <h2>Reports</h2>
        <div class="row">
          <label>Choose item/banquet/add-on
            <select id="reportItem">
              <option value="" disabled selected>Loading items…</option>
            </select>
          </label>
          <label>Send To (optional override)
            <input id="reportTo" type="email" placeholder="chair@example.com">
          </label>
          <button id="sendNow" class="btn btn-primary">Send Full Report Now</button>
        </div>
        <p class="tiny">If “Send To” is blank, the system emails the item’s chairperson(s) and CCs you automatically.</p>
        <div id="reportStatus" class="status tiny"></div>
      </section>
    </main>
  </div>

  <!-- (optional) keep your site settings script -->
  <script src="/assets/js/site-settings.js"></script>
  <script>
    // demo save button (unchanged)
    document.getElementById('save').onclick = ()=>{
      alert('Saved locally. (Production Admin will store settings in the database.)');
    };

    // -------- Reports wiring --------
    const sel = document.getElementById('reportItem');
    const statusEl = document.getElementById('reportStatus');

    function setStatus(msg, ok=true){
      statusEl.textContent = msg || '';
      statusEl.style.color = ok ? '#14532d' : '#7f1d1d';
    }

    async function loadRegisteredItems(){
      try{
        setStatus('Loading items…');
        const res = await fetch('/api/admin/list-registered-items');
        const data = await res.json();
        const items = Array.isArray(data.items) ? data.items : [];

        if (!items.length){
          sel.innerHTML = '<option value="" disabled selected>No items registered yet</option>';
          setStatus('No items found. Visit Banquets/Add-Ons/Catalog pages once so they auto-register.', false);
          return;
        }

        // sort by name for convenience
        items.sort((a,b)=>a.name.localeCompare(b.name));

        sel.innerHTML = '<option value="" disabled selected>Select an item…</option>' +
          items.map(i=>`<option value="${i.id}">${i.name}</option>`).join('');

        setStatus(`Loaded ${items.length} item(s).`);
      }catch(e){
        console.error(e);
        sel.innerHTML = '<option value="" disabled selected>Error loading items</option>';
        setStatus('Failed to load items.', false);
      }
    }

    async function sendFullReport(){
      const id = sel.value;
      const to = (document.getElementById('reportTo').value || '').trim();
      if (!id){ setStatus('Please choose an item first.', false); return; }

      setStatus('Sending report…');
      try{
        const url = to
          ? `/api/admin/send-full?itemId=${encodeURIComponent(id)}&to=${encodeURIComponent(to)}`
          : `/api/admin/send-full?itemId=${encodeURIComponent(id)}`;

        const res = await fetch(url);
        const data = await res.json();
        if (!res.ok) throw new Error(data?.error || 'send failed');

        setStatus(`Report sent. ${data.sentTo ? 'Recipients: ' + data.sentTo.join(', ') : ''}`);
      }catch(e){
        console.error(e);
        setStatus('Failed to send report: ' + e.message, false);
      }
    }

    document.getElementById('sendNow').addEventListener('click', sendFullReport);
    loadRegisteredItems();
  </script>
</body>
</html>
