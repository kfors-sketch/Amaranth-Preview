<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Grand Court Add-Ons">
  <link rel="icon" href="assets/img/favicon.svg" type="image/svg+xml">
  <link rel="stylesheet" href="assets/css/styles.css?v=addons-v10"><!-- bumped -->
  <title>Grand Court Add-Ons</title>
</head>

<body data-page="addons">
  <div class="wallpaper" style="--wallpaper: url('/assets/img/wallpaper.jpg')"></div>

  <!-- Header / Logo + Nav -->
  <header class="site-header">
    <div class="container header-inner">
      <a class="logo" href="home.html">
        <img src="assets/img/logo.svg" alt="Logo">
      </a>
      <span class="site-title">Order of the Amaranth</span>
      <nav class="site-nav nav">
        <a href="home.html">Home</a>
        <a href="banquet.html">Banquets</a>
        <span class="nav-current">Grand Court Add-Ons</span>
        <a href="product-catalog.html" data-catalog-link>Product Catalog</a>
        <a href="order.html">Order</a>
      </nav>
    </div>
  </header>

  <main class="container mt-lg">
    <h1 class="page-title" style="text-align:center;font-weight:800;">Grand Court Add-Ons</h1>

    <!-- Attendees (shared with Banquets/Order via Cart) -->
    <section class="card" style="background:rgba(255,255,255,0.40);backdrop-filter:saturate(120%) blur(2px);-webkit-backdrop-filter:saturate(120%) blur(2px);">
      <h2>Attendees</h2>
      <form id="attForm" class="att-form" autocomplete="off">
        <div class="grid-3">
          <input name="name"  placeholder="Name *" required>
          <input name="email" type="email" placeholder="Email *" required>
          <input name="phone" type="tel" inputmode="tel" placeholder="Phone *" required>
        </div>
        <div class="grid-3">
          <!-- Title required -->
          <input name="title" placeholder="Title *" required>
          <input name="notes" placeholder="Notes (e.g., dietary)">
          <input name="addr1" placeholder="Address line 1 *" required>
        </div>
        <div class="grid-3">
          <input name="addr2" placeholder="Address line 2">
          <input name="city" placeholder="City *" required>
          <input name="state" placeholder="State/Province *" required>
        </div>
        <div class="grid-3">
          <input name="postal" placeholder="Postal code *" required>
          <input name="country" placeholder="Country *" value="US" required>
          <span></span>
        </div>
        <button type="submit">Add attendee</button>
      </form>
      <div id="attendees"></div>
    </section>

    <!-- Add-ons grid -->
    <section class="grid-2 mt-lg" id="addonsGrid"></section>
  </main>

  <footer class="site-footer">
    <div class="container tiny">Â© 2025</div>
  </footer>

  <style>
    .att-form input{margin:4px;padding:6px}
    .att-card{display:flex;gap:8px;align-items:center;justify-content:space-between;background:rgba(255,255,255,0.78);border:1px solid rgba(0,0,0,0.06);border-radius:10px;padding:8px;margin:6px 0}
    .addon .row{display:flex;flex-wrap:wrap;gap:12px;align-items:flex-end}
    .addon label{display:flex;flex-direction:column;gap:6px}
    .addon input,.addon select{padding:.55rem .7rem;border:1px solid #d1d5db;border-radius:.5rem;background:rgba(255,255,255,0.9)}
    .grid-3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px}
  </style>

  <!-- Core site scripts (order matters) -->
  <script src="assets/js/site-settings.js"></script>
  <script src="assets/js/items.js"></script>
  <script src="assets/js/banquets.js"></script>
  <script src="assets/js/cart.js"></script>
  <script src="assets/js/data-store.js"></script>
  <script src="assets/js/site-boot.js"></script>
  <script src="assets/js/grand-court-addons.js"></script>

  <!-- ===== Phone helpers (US dashes; keep +international) ===== -->
  <script>
    function formatPhoneLive(inputEl){
      if (!inputEl) return;
      const raw = (inputEl.value || '').trim();
      if (raw.startsWith('+')) return; // preserve international numbers

      const helpers = (window.Cart && Cart.phoneHelpers) || null;
      if (helpers) {
        const d = helpers.digitsOnly(raw).slice(0, 10);
        inputEl.value = helpers.formatUS(d);
        return;
      }

      // Fallback if Cart.phoneHelpers is not defined
      const d = String(raw).replace(/\D+/g, '').slice(0, 10);
      if (d.length <= 3) {
        inputEl.value = d;
      } else if (d.length <= 6) {
        inputEl.value = d.slice(0, 3) + '-' + d.slice(3);
      } else {
        inputEl.value = d.slice(0, 3) + '-' + d.slice(3, 6) + '-' + d.slice(6, 10);
      }
    }
  </script>

  <!-- Page logic: attendees list, validation, dedupe, live phone dashes -->
  <script>
  function looksLikeEmail(s){ return /^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(String(s||'').trim()); }

  // === Duplicate detection helpers (shared) ===
  function _norm(s){ return String(s||'').trim().toLowerCase().replace(/\s+/g,' '); }
  function _addressKey(a){
    return [
      _norm(a?.address1),
      _norm(a?.address2),
      _norm(a?.city),
      _norm(a?.state),
      _norm(a?.postal),
      _norm(a?.country || 'US')
    ].join('|');
  }
  function _sameNameAndAddress(a, b){
    return _norm(a?.name) === _norm(b?.name) &&
           _addressKey(a)  === _addressKey(b);
  }

  // ===== Shared attendee storage (same key as order/banquets) =====
  const ATTENDEE_STORAGE_KEY = "amaranth_attendees_v1";

  function saveAttendeesToStorage(list){
    try {
      const arr = Array.isArray(list) ? list : [];
      localStorage.setItem(ATTENDEE_STORAGE_KEY, JSON.stringify(arr));
    } catch(e){
      console.error("Failed to save attendees to shared storage", e);
    }
  }

  function syncAttendeesToStorageFromCart(){
    try {
      if (!window.Cart || typeof Cart.get !== "function") return;
      const st = Cart.get() || {};
      const attendees = Array.isArray(st.attendees) ? st.attendees : [];
      saveAttendeesToStorage(attendees);
    } catch(e){
      console.error("Failed to sync attendees from Cart to storage", e);
    }
  }

  document.addEventListener('DOMContentLoaded', function(){
    const attForm = document.getElementById('attForm');
    const list = document.getElementById('attendees');

    // Ensure Cart is loaded (shared cart for all pages)
    if (window.Cart && typeof Cart.load === 'function') {
      try { Cart.load(); } catch(e){}
    }

    // Initial mirror to shared storage
    syncAttendeesToStorageFromCart();

    // Phone live formatting (+international untouched)
    const phoneField = attForm?.querySelector('input[name="phone"]');
    if (phoneField){
      phoneField.addEventListener('input', ()=>formatPhoneLive(phoneField));
      phoneField.addEventListener('blur',  ()=>formatPhoneLive(phoneField));
    }

    function renderAttendees(){
      const st = Cart.get();
      list.innerHTML = (st.attendees||[]).map(a=>{
        const hasAddr = !!(a?.address1 && a?.city && a?.state && a?.postal && a?.country);
        const addrLine = hasAddr ? 'Mailing address: attached' : 'Mailing address: missing';
        const phone = a?.phone ? ` â€¢ ${a.phone}` : '';
        return `
          <div class="att-card">
            <div>
              <strong>${a.name||''}</strong>
              <small>${a.email||''}</small>
              <em>${a.title||''}</em>
              <div class="tiny" style="opacity:.9;margin-top:2px;">${addrLine}${phone}</div>
              ${a.notes ? `<div class="tiny" style="opacity:.8;margin-top:2px;">Notes: ${String(a.notes).replace(/</g,'&lt;')}</div>` : ''}
            </div>
            <button data-del="${a.id}">Remove</button>
          </div>
        `;
      }).join('');
      list.querySelectorAll('button[data-del]').forEach(btn=>{
        btn.onclick = ()=>{
          Cart.removeAttendee(btn.dataset.del);
          renderAttendees();
          // keep shared storage in sync after removal
          syncAttendeesToStorageFromCart();
        };
      });

      // Mirror current attendees to shared storage on every render
      syncAttendeesToStorageFromCart();
    }

    if (attForm){
      attForm.onsubmit = (e)=>{
        e.preventDefault();
        const fd = new FormData(attForm);

        const name   = (fd.get('name')||'').trim();
        const email  = (fd.get('email')||'').trim();
        const phone  = (fd.get('phone')||'').trim();
        const title  = (fd.get('title')||'').trim(); // required
        const notes  = (fd.get('notes')||'').trim();

        const address1 = (fd.get('addr1')||'').trim();
        const address2 = (fd.get('addr2')||'').trim();
        const city     = (fd.get('city')||'').trim();
        const state    = (fd.get('state')||'').trim();
        const postal   = (fd.get('postal')||'').trim();
        const country  = (fd.get('country')||'US').trim() || 'US';

        const missing = [];
        if (!name) missing.push('Name');
        if (!email || !looksLikeEmail(email)) missing.push('Valid Email');
        if (!phone) missing.push('Phone');
        if (!title) missing.push('Title');
        if (!address1) missing.push('Address line 1');
        if (!city) missing.push('City');
        if (!state) missing.push('State/Province');
        if (!postal) missing.push('Postal code');
        if (!country) missing.push('Country');
        if (missing.length){
          alert('Please complete the following fields:\nâ€¢ ' + missing.join('\nâ€¢ '));
          return;
        }

        // ===== Duplicate prevention =====
        const st = Cart.get() || { attendees: [] };
        const incoming = { name, address1, address2, city, state, postal, country };

        // A) Same name + email
        const existsNameEmail = (st.attendees||[]).some(a =>
          _norm(a.name)  === _norm(name) &&
          _norm(a.email) === _norm(email)
        );

        // B) Same name + full mailing address
        const existsNameAddress = (st.attendees||[]).some(a => _sameNameAndAddress(a, incoming));

        if (existsNameEmail || existsNameAddress){
          alert('That attendee already exists (same name with same email or address).');
          return;
        }
        // =================================

        Cart.addAttendee({
          name, email, phone, title, notes,
          address1, address2, city, state, postal, country
        });
        attForm.reset();
        attForm.querySelector('input[name="country"]').value = 'US';
        renderAttendees();
        // sync new list out to shared storage
        syncAttendeesToStorageFromCart();
      };
    }

    renderAttendees();

    // ===== KEEP IN SYNC WITH OTHER PAGES =====
    function resyncFromStorage(){
      try { Cart.load(); } catch(e){}
      try {
        renderAttendees();
        syncAttendeesToStorageFromCart();
      } catch(e){}
    }

    // When cart changes anywhere in this tab
    window.addEventListener('cart:updated', () => {
      try {
        renderAttendees();
        syncAttendeesToStorageFromCart();
      } catch(e){}
    });

    // When tab regains focus / becomes visible
    window.addEventListener('focus', resyncFromStorage);
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) resyncFromStorage();
    });

    // Cross-tab/localStorage sync
    window.addEventListener('storage', (ev) => {
      try {
        if (!ev.key || ev.key === Cart.LS_KEY) {
          resyncFromStorage();
        }
      } catch(e){}
    });
  });
  </script>

  <!-- Strip attendeeNotes from Add-Ons (unchanged behavior) -->
  <script>
  document.addEventListener('DOMContentLoaded', function(){
    if (document.body?.dataset?.page === 'addons' && window.Cart && typeof Cart.addLine === 'function'){
      const _add = Cart.addLine.bind(Cart);
      Cart.addLine = function(line){
        try{
          const copy = JSON.parse(JSON.stringify(line || {}));
          if (copy?.meta && Object.prototype.hasOwnProperty.call(copy.meta,'attendeeNotes')){
            delete copy.meta.attendeeNotes;
          }
          return _add(copy);
        }catch(e){ return _add(line); }
      };
    }
  });
  </script>

  <!-- Hide Product Catalog link if no visible items -->
<script>
(async function(){
  const link = document.querySelector('[data-catalog-link]');
  if (!link) return;

  async function fetchJson(url){
    try {
      const r = await fetch(url, { cache: 'no-store' });
      if (!r.ok) return null;
      return await r.json();
    } catch(e){ return null; }
  }

  let items = [];
  let j = await fetchJson('/api/router?type=products');
  if (Array.isArray(j?.products)) items = j.products;

  if (!items.length && Array.isArray(window.CATALOG_ITEMS)) items = window.CATALOG_ITEMS;

  const now = Date.now();
  const hasVisible = (items || []).some(i => {
    if (!i || i.active === false) return false;
    const s = i.publishStart ? Date.parse(i.publishStart) : null;
    const e = i.publishEnd   ? Date.parse(i.publishEnd) : null;
    return (s == null || now >= s) && (e == null || now <= e);
  });

  if (!hasVisible) link.style.display = 'none';
})();
</script>

  <!-- Maintenance check -->
  <script>
  (async () => {
    try {
      const resp = await fetch('/api/router?type=settings');
      const data = await resp.json();

      const on  = data?.effective?.MAINTENANCE_ON ?? data?.MAINTENANCE_ON;
      const msg = data?.effective?.MAINTENANCE_MESSAGE ?? data?.MAINTENANCE_MESSAGE;

      if (on === 'true' || on === true) {
        document.body.innerHTML = `
          <div style="display:flex;flex-direction:column;justify-content:center;align-items:center;height:100vh;background:#fef2f2;color:#b91c1c;font-family:sans-serif;text-align:center;padding:20px">
            <h1 style="font-size:2em;margin-bottom:12px;">ðŸ›  Under Maintenance</h1>
            <p style="font-size:1.2em;max-width:500px;">
              ${msg || 'The site is temporarily unavailable. Please check back soon.'}
            </p>
          </div>
        `;
      }
    } catch (err) {
      console.error('Maintenance check failed:', err);
    }
  })();
  </script>

</body>
</html>
