<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Product Catalog — Amaranth</title>
<meta name="robots" content="noindex, nofollow"/>
<link rel="stylesheet" href="/assets/css/styles.css"/>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f7f7fb;color:#111;margin:0}
  .container{max-width:1200px;margin:24px auto;padding:0 16px}
  .row{display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap}
  .col{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:14px}
  .col.left{flex:2 1 640px;min-width:520px}
  .col.right{flex:1 1 480px;min-width:420px;position:sticky;top:16px}
  .btn{height:36px;border:1px solid #d1d5db;background:#111;color:#fff;border-radius:10px;padding:0 12px;font-weight:700;cursor:pointer}
  .btn.ghost{background:#fff;color:#111}
  input,select,textarea{width:100%;border:1px solid #d1d5db;border-radius:10px;padding:8px;background:#fff}
  table{width:100%;border-collapse:separate;border-spacing:0}
  thead th{background:#fafafa;border-bottom:1px solid #e5e7eb;color:#6b7280;font-size:12px;letter-spacing:.04em;text-transform:uppercase;padding:10px;text-align:left;position:sticky;top:0}
  tbody td{padding:10px;border-bottom:1px solid #f1f2f6;vertical-align:top}
  .muted{color:#6b7280}
  .ok{color:#065f46}.danger{color:#b91c1c}
  .preview{width:96px;height:96px;object-fit:cover;border:1px solid #e5e7eb;border-radius:10px;background:#fafafa;margin-bottom:6px}
</style>
<script>
  (function(){
    if(localStorage.getItem('amaranth_admin_pw_ok')!=='1'){
      location.replace('/admin/reporting_login.html');
    }
  })();
</script>
</head>
<body>
<main class="container">
  <header style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
    <div><h1 style="margin:0">Product Catalog</h1><div class="muted">Create, edit, retire products</div></div>
    <div style="display:flex;gap:8px;align-items:center">
      <a class="btn ghost" href="/admin/index.html">← Admin Hub</a>
      <button id="refreshBtn" class="btn ghost">Refresh</button>
      <button id="logoutBtn" class="btn ghost" style="height:34px">Log Out</button>
    </div>
  </header>

  <div class="row">
    <section class="col left">
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap">
        <button id="btnNew" class="btn">+ New Product</button>
        <button id="btnExport" class="btn ghost">Export JSON</button>
        <button id="btnExportCsv" class="btn ghost">Export CSV</button>
        <label class="btn ghost" for="fileImport" style="cursor:pointer">Import JSON</label>
        <input id="fileImport" type="file" accept=".json,application/json" style="display:none"/>
        <span id="listMsg" class="muted"></span>
      </div>
      <div style="overflow:auto;max-height:65vh">
        <table><thead><tr>
          <th style="min-width:200px">Name</th>
          <th style="min-width:140px">ID</th>
          <th>Price</th><th>Active</th>
          <th>Publish Window</th><th style="min-width:160px">Actions</th>
        </tr></thead><tbody id="tbody"></tbody></table>
      </div>
    </section>

    <aside class="col right">
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
        <strong id="modeChip">New</strong><span id="editMsg" class="muted"></span>
      </div>

      <label>Name</label><input id="f_name" type="text" placeholder="Product name"/>
      <label>ID</label><input id="f_id" type="text" placeholder="product-id"/>
      <label>Price (USD)</label><input id="f_price" type="number" step="0.01" min="0" placeholder="15.00"/>

      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <div style="flex:1 1 120px"><label>Active</label><select id="f_active"><option>true</option><option>false</option></select></div>
        <div style="flex:1 1 180px"><label>Publish Start</label><input id="f_start" type="datetime-local"/></div>
        <div style="flex:1 1 180px"><label>Publish End</label><input id="f_end" type="datetime-local"/></div>
      </div>

      <label>Notes / Description</label><textarea id="f_notes" placeholder="Shown on product page"></textarea>

      <h3 style="margin-top:14px">Images</h3>
      <div>
        <label>Thumbnail</label>
        <img id="thumbPreview" class="preview" alt="thumbnail"/>
        <input id="f_thumb" type="file" accept="image/*"/>
        <input id="f_thumb_url" type="text" placeholder="Thumbnail URL (optional)"/>
      </div>
      <div style="margin-top:8px">
        <label>Main Image</label>
        <img id="img1Preview" class="preview" alt="main image"/>
        <input id="f_img1" type="file" accept="image/*"/>
        <input id="f_img1_url" type="text" placeholder="Main image URL (optional)"/>
      </div>

      <div style="display:flex;gap:8px;align-items:center;margin-top:12px">
        <button id="btnSave" class="btn">Save</button>
        <button id="btnReset" class="btn ghost">Reset</button>
      </div>
    </aside>
  </div>
</main>

<script src="/assets/js/lib/csv.js"></script>
<script src="/assets/js/admin.js"></script>

<script>
const $ = s=>document.querySelector(s);
let model=[], current=null, isNew=true;

// endpoints
const READ_URL  = '/api/router?type=products';
const WRITE_URL = '/api/router?action=save_products';
const UPLOAD_URL = '/api/router?action=upload_product_image';

// utils
function toLocalDT(v){if(!v)return'';const d=new Date(v);if(isNaN(d))return'';const z=new Date(d.getTime()-d.getTimezoneOffset()*60000);return z.toISOString().slice(0,16);}
function fromLocalDT(v){if(!v)return'';const d=new Date(v);return isNaN(d)?'':d.toISOString();}
function esc(s){return(s??'').toString().replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));}
function setMsg(el,t,ok){el.textContent=t||'';el.className=ok?'ok':(t?'danger':'muted');}

// image previews
function setPreview(sel, url){
  const img=$(sel); if(!img)return;
  if(url){ img.src=url; img.style.opacity='1'; }
  else{ img.removeAttribute('src'); img.style.opacity='0.35'; }
}
function previewLocalFile(inputSel, imgSel){
  const inp=$(inputSel), img=$(imgSel);
  if(!inp||!img)return;
  const f=inp.files&&inp.files[0];
  if(!f){setPreview(imgSel,null);return;}
  const reader=new FileReader();
  reader.onload=()=>{img.src=reader.result;img.style.opacity='1';};
  reader.readAsDataURL(f);
}
$('#f_thumb').addEventListener('change',()=>previewLocalFile('#f_thumb','#thumbPreview'));
$('#f_img1').addEventListener('change',()=>previewLocalFile('#f_img1','#img1Preview'));

// upload file -> router (base64 JSON)
async function uploadIfChosen(fileInputId, productId, slot){
  const inp=$(fileInputId);
  if(!inp||!inp.files||!inp.files[0])return null;
  const file=inp.files[0];
  const dataUrl=await new Promise((res,rej)=>{
    const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file);
  });
  const headers={"Content-Type":"application/json",...Admin.tokenHeader()};
  const r=await fetch(UPLOAD_URL,{
    method:'POST',
    headers,
    body:JSON.stringify({id:productId,slot,dataUrl})
  });
  const j=await r.json().catch(()=>({}));
  if(!r.ok||!j?.url)throw new Error(j?.error||'upload failed');
  return j.url;
}

// load/save
async function loadServer(){
  try{const r=await fetch(READ_URL,{cache:'no-store'});if(!r.ok)throw 0;
  const j=await r.json();if(Array.isArray(j.products))model=j.products;}catch{model=[];}
}
function loadFallbackFromWindow(){
  if(!model.length&&Array.isArray(window.PRODUCTS))model=JSON.parse(JSON.stringify(window.PRODUCTS));
}
function renderList(){
  const tb=$('#tbody');tb.innerHTML='';
  if(!model.length){tb.innerHTML='<tr><td colspan="6" class="muted">No products yet</td></tr>';return;}
  for(const a of model){
    const tr=document.createElement('tr');
    const start=a.publishStart?new Date(a.publishStart).toLocaleString():'—';
    const end=a.publishEnd?new Date(a.publishEnd).toLocaleString():'—';
    tr.innerHTML=`
      <td><strong>${esc(a.name||'')}</strong></td>
      <td><code>${esc(a.id||'')}</code></td>
      <td>$${Number(a.price||0).toFixed(2)}</td>
      <td>${a.active===false?'<span class="danger">false</span>':'<span class="ok">true</span>'}</td>
      <td class="muted">${start} → ${end}</td>
      <td><button class="btn ghost btnEdit" data-id="${esc(a.id)}">Edit</button></td>`;
    tb.appendChild(tr);
  }
  tb.querySelectorAll('.btnEdit').forEach(b=>b.addEventListener('click',onEdit));
}
function startNew(){
  isNew=true;
  current={id:'',name:'',price:0,active:true,publishStart:'',publishEnd:'',notes:'',thumbnailUrl:'',imageUrl:''};
  fillForm(current);
  $('#modeChip').textContent='New';$('#editMsg').textContent='Create new product.';
}
function fillForm(p){
  $('#f_name').value=p.name||'';$('#f_id').value=p.id||'';$('#f_price').value=p.price??'';
  $('#f_active').value=String(p.active!==false);$('#f_start').value=toLocalDT(p.publishStart);$('#f_end').value=toLocalDT(p.publishEnd);
  $('#f_notes').value=p.notes||'';$('#f_thumb_url').value=p.thumbnailUrl||'';$('#f_img1_url').value=p.imageUrl||'';
  setPreview('#thumbPreview',p.thumbnailUrl);setPreview('#img1Preview',p.imageUrl);
  $('#f_thumb').value='';$('#f_img1').value='';
}
function readForm(){
  return{
    name:$('#f_name').value.trim(),
    id:$('#f_id').value.trim(),
    price:Number($('#f_price').value||0),
    active:$('#f_active').value==='true',
    publishStart:fromLocalDT($('#f_start').value),
    publishEnd:fromLocalDT($('#f_end').value),
    notes:$('#f_notes').value.trim(),
    thumbnailUrl:$('#f_thumb_url').value.trim(),
    imageUrl:$('#f_img1_url').value.trim()
  };
}
function validate(p){
  if(!p.name)return'Name required';
  if(!p.id||!/^[a-z0-9-]+$/.test(p.id))return'ID must be lowercase letters, numbers, dashes';
  if(p.price<0||isNaN(p.price))return'Invalid price';
  if(p.publishStart&&isNaN(new Date(p.publishStart)))return'Invalid start';
  if(p.publishEnd&&isNaN(new Date(p.publishEnd)))return'Invalid end';
  if(p.publishStart&&p.publishEnd&&new Date(p.publishStart)>new Date(p.publishEnd))return'Start must be before end';
  return null;
}
function onEdit(e){
  const id=e.currentTarget.dataset.id;
  const p=model.find(x=>x.id===id);if(!p)return;
  isNew=false;current=p;fillForm(p);
  $('#modeChip').textContent='Edit';$('#editMsg').textContent=`Editing ${p.name}`;
}

// buttons
$('#btnNew').onclick=startNew;
$('#btnReset').onclick=()=>fillForm(current||{});
$('#refreshBtn').onclick=async()=>{await loadServer();loadFallbackFromWindow();renderList();startNew();};

$('#btnExport').onclick=()=>{
  const blob=new Blob([JSON.stringify({PRODUCTS:model},null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='products-export.json';a.click();
};

// Save
$('#btnSave').onclick=async()=>{
  const obj=readForm();const err=validate(obj);
  if(err){setMsg($('#editMsg'),err,false);return;}
  setMsg($('#editMsg'),'Saving…',true);
  try{
    if(obj.id){
      const thumbUrl=await uploadIfChosen('#f_thumb',obj.id,'thumb');
      if(thumbUrl)obj.thumbnailUrl=thumbUrl;
      const mainUrl=await uploadIfChosen('#f_img1',obj.id,'image1');
      if(mainUrl)obj.imageUrl=mainUrl;
    }
  }catch(e){console.warn('upload fail',e);}

  if(isNew)model.push(obj);else{
    const i=model.findIndex(x=>x.id===current.id);
    if(i>=0)model[i]=obj;else model.push(obj);
  }
  current=obj;renderList();

  try{
    const headers={'Content-Type':'application/json',...Admin.tokenHeader()};
    const r=await fetch(WRITE_URL,{method:'POST',headers,body:JSON.stringify({products:model})});
    const j=await r.json().catch(()=>({}));
    if(!r.ok)throw new Error(j?.error||'server rejected');
    setMsg($('#editMsg'),'Saved to server.',true);
  }catch{setMsg($('#editMsg'),'Saved locally (server error).',false);}
};

// logout
$('#logoutBtn').onclick=()=>{localStorage.removeItem('amaranth_admin_pw_ok');location.href='/admin/reporting_login.html';};

// init
(async()=>{await loadServer();loadFallbackFromWindow();renderList();startNew();})();
</script>

<script>window.PRODUCTS=window.PRODUCTS||[];</script>
</body>
</html>
