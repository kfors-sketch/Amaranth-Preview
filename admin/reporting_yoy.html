<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Amaranth Admin — Year-over-Year</title>
  <meta name="robots" content="noindex, nofollow" />

  <!-- Shared styles (includes .help-btn and modal styles) -->
  <link rel="stylesheet" href="/assets/css/styles.css" />

  <style>
    *,*::before,*::after{box-sizing:border-box}
    html,body{margin:0;padding:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;background:#f7f7fb;color:#111}
    a{color:inherit;text-decoration:none}
    button{cursor:pointer}
    .container{max-width:1200px;margin:24px auto;padding:0 16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:14px}
    .card h3{margin:0 0 8px;font-size:15px;color:#374151}
    .card p{margin:4px 0 8px;font-size:13px;color:#4b5563}
    .muted{color:#6b7280;font-size:12px}
    .row{display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap}
    .col{flex:1 1 0;min-width:260px}
    .controls{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
    .controls label{font-size:12px;color:#4b5563}
    .controls input,.controls select{width:100%;height:32px;border-radius:8px;border:1px solid #d1d5db;padding:0 8px;font-size:13px}
    .controls .group{flex:1 1 120px;min-width:120px}
    .btn{height:32px;border-radius:999px;border:1px solid #d1d5db;background:#111;color:#fff;font-size:13px;padding:0 14px;font-weight:600;display:inline-flex;align-items:center;justify-content:center;text-decoration:none}
    .btn.secondary{background:#fff;color:#111}
    .btn.sm{height:28px;font-size:12px;padding:0 10px}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px;align-items:center}
    .toolbar .spacer{flex:1 1 auto}
    .section-label{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.06em;color:#6b7280;margin-bottom:4px}
    .heading-row{display:flex;justify-content:space-between;align-items:flex-end;gap:8px;margin-bottom:12px}
    .heading-row h2{
      margin:0;
      font-size:20px;
      color:#111827;
      display:flex;
      align-items:center;
      gap:6px;
      flex-wrap:wrap;
    }
    .heading-row .muted{font-size:12px;max-width:420px}
    .heading-actions{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:flex-end}
    .metric-chip{display:inline-flex;align-items:center;border-radius:999px;border:1px solid #e5e7eb;padding:2px 8px;font-size:11px;background:#f9fafb;color:#374151;margin-right:4px;margin-bottom:4px}
    .metric-chip span{opacity:.7;margin-left:4px}
    .text-sm{font-size:12px}
    .text-xs{font-size:11px}
    .mb-4{margin-bottom:4px}
    .mb-8{margin-bottom:8px}
    .mb-12{margin-bottom:12px}
    .mb-16{margin-bottom:16px}
    .mt-4{margin-top:4px}
    .mt-8{margin-top:8px}
    .mt-12{margin-top:12px}
    .text-right{text-align:right}
    .table-wrap{max-height:480px;overflow:auto;border-radius:12px;border:1px solid #e5e7eb;background:#fff}
    table{width:100%;border-collapse:collapse;font-size:12px}
    th,td{border-bottom:1px solid #e5e7eb;padding:6px 4px;text-align:left;vertical-align:top}
    th{font-size:11px;text-transform:uppercase;letter-spacing:.03em;color:#6b7280;background:#f9fafb;position:sticky;top:0;z-index:1}
    tr:nth-child(even){background:#f9fafb}
    .pill{display:inline-flex;align-items:center;border-radius:999px;padding:2px 8px;font-size:11px;border:1px solid #e5e7eb;background:#f9fafb}
    .pill.green{border-color:#16a34a;color:#166534;background:#ecfdf3}
    .pill.red{border-color:#dc2626;color:#b91c1c;background:#fef2f2}
    .pill.gray{border-color:#9ca3af;color:#4b5563;background:#f3f4f6}
    .chart-row{display:flex;flex-wrap:wrap;gap:12px;margin-top:8px}
    .chart-box{flex:1 1 260px;min-height:140px;border-radius:12px;border:1px dashed #e5e7eb;padding:10px;background:#f9fafb;font-size:11px;color:#4b5563}
    .chart-title{font-weight:600;margin-bottom:6px}
    .bar-row{display:flex;align-items:center;gap:6px;margin-bottom:4px}
    .bar-label{flex:0 0 70px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .bar-track{flex:1 1 auto;height:8px;border-radius:999px;background:#e5e7eb;overflow:hidden}
    .bar-fill{height:100%;border-radius:999px;background:#2563eb}
    .bar-fill.compare{background:#f97316}
    .legend{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px;font-size:11px}
    .legend span{display:inline-flex;align-items:center;gap:4px}
    .legend-swatch{width:10px;height:10px;border-radius:999px;background:#2563eb}
    .legend-swatch.compare{background:#f97316}
    .legend-swatch.delta{background:#16a34a}
    @media(max-width:768px){
      .row{flex-direction:column}
      .heading-row{flex-direction:column;align-items:flex-start}
      .heading-actions{justify-content:flex-start}
      .table-wrap{max-height:none}
    }
    @media print{
      .heading-actions,.toolbar{display:none !important}
      body{background:#fff}
      .container{margin:0 auto;padding:8px}
      .card{box-shadow:none}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="heading-row">
      <div>
        <h2>
          Year-over-Year Overview
          <button
            type="button"
            class="help-btn"
            data-help-id="yoy_main"
            aria-label="Help for Year-over-Year Overview"
          >?</button>
        </h2>
        <p class="muted">
          Compare totals between two years by category and slot (banquets, add-ons, catalog).
        </p>
      </div>
      <div class="heading-actions">
        <a href="/admin/index.html" class="btn secondary sm">← Admin Hub</a>
        <a href="/admin/reporting_main.html" class="btn secondary sm">Reporting Dashboard</a>
        <button id="btnYoYPrint" class="btn secondary sm">Print</button>
        <button id="btnYoYExport" class="btn sm">Export (.csv)</button>
      </div>
    </div>

    <!-- Filters -->
    <div class="card mb-16">
      <div class="section-label">Filters</div>
      <h3>
        Choose years and view
        <button
          type="button"
          class="help-btn"
          data-help-id="yoy_filters"
          aria-label="Help for Year-over-Year filters"
        >?</button>
      </h3>
      <p class="muted">These options control the charts and table below.</p>
      <div class="controls mt-4">
        <div class="group">
          <label class="muted">Category</label>
          <select id="yCategory">
            <option value="">All</option>
            <option value="banquet">Banquets</option>
            <option value="addon">Add-ons</option>
            <option value="catalog">Catalog</option>
          </select>
        </div>
        <div class="group">
          <label class="muted">Slot</label>
          <select id="ySlot">
            <!-- populated from index endpoint -->
          </select>
        </div>
        <div class="group">
          <label class="muted">Base year</label>
          <select id="yBase">
            <!-- populated from index endpoint -->
          </select>
        </div>
        <div class="group">
          <label class="muted">Compare to year</label>
          <select id="yCompare">
            <!-- populated from index endpoint -->
          </select>
        </div>
        <div class="group">
          <label class="muted">Metric</label>
          <select id="yMetric">
            <option value="amount">Total amount</option>
            <option value="orders">Order count</option>
            <option value="purchasers">Purchasers</option>
            <option value="items">Items sold</option>
          </select>
        </div>
      </div>
      <p class="muted mt-4" id="yStatus"></p>
    </div>

    <div class="row">
      <!-- LEFT: Headline + charts -->
      <div class="col">
        <div class="card mb-12">
          <div class="section-label">Headline</div>
          <h3>
            <span id="yHeadline">No data loaded yet</span>
            <button
              type="button"
              class="help-btn"
              data-help-id="yoy_headline"
              aria-label="Help for Year-over-Year headline summary"
            >?</button>
          </h3>
          <p class="muted" id="ySubheadline">
            Adjust filters above, then the dashboard will summarize the comparison here.
          </p>
          <div class="mt-8 text-sm">
            <div class="metric-chip">
              Base year <span id="yLabelBase">—</span>
            </div>
            <div class="metric-chip">
              Compare year <span id="yLabelCompare">—</span>
            </div>
            <div class="metric-chip">
              Metric <span id="yLabelMetric">amount</span>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="section-label">Charts</div>
          <h3>
            Change by year
            <button
              type="button"
              class="help-btn"
              data-help-id="yoy_charts"
              aria-label="Help for Year-over-Year charts"
            >?</button>
          </h3>
          <p class="muted">Bars show totals for each year; line shows difference between them.</p>
          <div class="chart-row" id="yCharts">
            <div class="chart-box">
              <div class="chart-title">Totals</div>
              <div id="yChartTotals"></div>
              <div class="legend">
                <span><span class="legend-swatch"></span> Base year</span>
                <span><span class="legend-swatch compare"></span> Compare year</span>
              </div>
            </div>
            <div class="chart-box">
              <div class="chart-title">Difference</div>
              <div id="yChartDelta"></div>
              <div class="legend">
                <span><span class="legend-swatch delta"></span> Δ vs base</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT: Breakdown table -->
      <div class="col">
        <div class="card">
          <div class="section-label">Breakdown</div>
          <h3>
            Per slot / category
            <button
              type="button"
              class="help-btn"
              data-help-id="yoy_breakdown"
              aria-label="Help for Year-over-Year breakdown table"
            >?</button>
          </h3>
          <p class="muted">Rough breakdown of totals for each slot. Export button downloads this as .csv.</p>
          <div class="table-wrap mt-8">
            <table>
              <thead>
                <tr>
                  <th>Slot</th>
                  <th>Category</th>
                  <th class="text-right">Base</th>
                  <th class="text-right">Compare</th>
                  <th class="text-right">Δ</th>
                  <th class="text-right">Δ %</th>
                </tr>
              </thead>
              <tbody id="yBreakdownBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // simple helpers
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    function money(n){
      const v = Math.round(Number(n || 0) * 100) / 100;
      return v.toLocaleString(undefined,{
        style:'currency',
        currency:'USD',
        minimumFractionDigits:2,
        maximumFractionDigits:2
      });
    }
    function pct(delta, base){
      const b = Number(base || 0);
      if (!b) return '—';
      const v = (Number(delta || 0) / b) * 100;
      return (v >= 0 ? '+' : '') + v.toFixed(1) + '%';
    }

    const state = {
      index:null,
      yoy:null,
      category:'',
      slot:'all',
      baseYear:null,
      compareYear:null,
      metric:'amount',
    };

    // ---------- Load index (years + slots) ----------
    async function loadIndex(){
      try{
        const r = await fetch('/api/router?type=year_index',{cache:'no-store'});
        const j = await r.json();
        if(!r.ok) throw new Error(j?.error || 'index failed');
        state.index = j || {};

        const years = Array.isArray(j.years) ? j.years.slice().sort((a,b)=>a-b) : [];
        const baseSel = $('#yBase');
        const cmpSel  = $('#yCompare');
        baseSel.innerHTML = '';
        cmpSel .innerHTML = '';
        years.forEach(y=>{
          const opt1 = document.createElement('option');
          opt1.value = opt1.textContent = y;
          baseSel.appendChild(opt1);
          const opt2 = document.createElement('option');
          opt2.value = opt2.textContent = y;
          cmpSel.appendChild(opt2);
        });
        if(years.length){
          baseSel.value = years[years.length-2] || years[0];
          cmpSel.value  = years[years.length-1];
          state.baseYear = Number(baseSel.value);
          state.compareYear = Number(cmpSel.value);
        }

        const slotSel = $('#ySlot');
        slotSel.innerHTML = '';
        const allOpt = document.createElement('option');
        allOpt.value = 'all';
        allOpt.textContent = 'All slots';
        slotSel.appendChild(allOpt);

        const slots = Array.isArray(j.slots) ? j.slots : [];
        slots.forEach(s=>{
          const opt = document.createElement('option');
          opt.value = s.key || s.slotKey || '';
          opt.textContent = s.label || s.name || opt.value || '(unnamed)';
          slotSel.appendChild(opt);
        });
        state.slot = 'all';

      }catch(e){
        console.warn('year_index error', e);
        $('#yStatus').textContent = 'Could not load year index.';
      }
    }

    // ---------- Load YoY data ----------
    async function loadYoy(){
      $('#yStatus').textContent = 'Loading…';
      try{
        const params = new URLSearchParams();
        if(state.category) params.set('category', state.category);
        if(state.slot && state.slot !== 'all') params.set('slot', state.slot);
        if(state.baseYear) params.set('baseYear', state.baseYear);
        if(state.compareYear) params.set('compareYear', state.compareYear);

        const r = await fetch('/api/router?type=year_multi&' + params.toString(), {cache:'no-store'});
        const j = await r.json();
        if(!r.ok) throw new Error(j?.error || 'year_multi failed');

        state.yoy = j || {};
        updateHeadline(j);
        updateCharts(j);
        updateBreakdown(j);

        $('#yStatus').textContent = '';
      }catch(e){
        console.warn('year_multi error', e);
        $('#yStatus').textContent = 'Could not load year-over-year data.';
      }
    }

    // ---------- Headline ----------
    function updateHeadline(yoy){
      const metric = state.metric || 'amount';
      const base = (yoy && yoy.summary && yoy.summary.base) || {};
      const cmp  = (yoy && yoy.summary && yoy.summary.compare) || {};

      const baseVal = pickMetric(base, metric);
      const cmpVal  = pickMetric(cmp, metric);
      const delta   = (cmpVal || 0) - (baseVal || 0);

      $('#yLabelBase').textContent    = String(state.baseYear || '—');
      $('#yLabelCompare').textContent = String(state.compareYear || '—');
      $('#yLabelMetric').textContent  = metricLabel(metric);

      if(baseVal == null && cmpVal == null){
        $('#yHeadline').textContent = 'No data for selected years.';
        $('#ySubheadline').textContent = 'Try a different category, slot, or year range.';
        return;
      }

      const niceBase  = metric === 'amount' ? money(baseVal) : baseVal.toLocaleString();
      const niceCmp   = metric === 'amount' ? money(cmpVal) : cmpVal.toLocaleString();
      const niceDelta = metric === 'amount' ? money(delta) : delta.toLocaleString();

      let direction = 'unchanged';
      if(delta > 0) direction = 'increased';
      else if(delta < 0) direction = 'decreased';

      $('#yHeadline').textContent =
        `${metricLabel(metric)} ${direction} by ${niceDelta} in ${state.compareYear} vs ${state.baseYear}.`;

      $('#ySubheadline').textContent =
        `Base year: ${state.baseYear} = ${niceBase}.  Compare year: ${state.compareYear} = ${niceCmp}.`;
    }

    function metricLabel(m){
      switch(m){
        case 'orders': return 'Order count';
        case 'purchasers': return 'Purchasers';
        case 'items': return 'Items sold';
        default: return 'Total amount';
      }
    }

    function pickMetric(obj, m){
      if(!obj) return 0;
      switch(m){
        case 'orders': return Number(obj.orders || obj.orderCount || 0);
        case 'purchasers': return Number(obj.purchasers || obj.buyerCount || 0);
        case 'items': return Number(obj.items || obj.itemCount || 0);
        default: return Number(obj.amount || obj.totalAmount || 0);
      }
    }

    // ---------- Charts ----------
    function updateCharts(yoy){
      const rows = Array.isArray(yoy?.rows) ? yoy.rows : [];
      const metric = state.metric || 'amount';

      const totalsEl = $('#yChartTotals');
      const deltaEl  = $('#yChartDelta');
      totalsEl.innerHTML = '';
      deltaEl.innerHTML  = '';

      if(!rows.length){
        totalsEl.textContent = 'No data.';
        deltaEl.textContent  = 'No data.';
        return;
      }

      // For chart rows, combine by slot (or whole dataset if slot==all)
      const map = new Map();
      for(const r of rows){
        const key = r.slotLabel || r.slot || r.slotKey || 'All';
        const rec = map.get(key) || {base:0, cmp:0, label:key};
        const year = Number(r.year || r.yr || 0);
        const val = pickMetric(r, metric);
        if(year === state.baseYear)  rec.base += val;
        if(year === state.compareYear) rec.cmp += val;
        map.set(key, rec);
      }
      const series = Array.from(map.values());

      // scale for bars
      let maxVal = 0;
      series.forEach(s=>{
        maxVal = Math.max(maxVal, s.base, s.cmp, Math.abs((s.cmp||0)-(s.base||0)));
      });
      if(!maxVal) maxVal = 1;

      // totals chart
      series.forEach(s=>{
        const row = document.createElement('div');
        row.className = 'bar-row';

        const label = document.createElement('div');
        label.className = 'bar-label';
        label.textContent = s.label;
        row.appendChild(label);

        const track = document.createElement('div');
        track.className = 'bar-track';

        const baseBar = document.createElement('div');
        baseBar.className = 'bar-fill';
        baseBar.style.width = (s.base / maxVal * 100) + '%';

        const cmpBar = document.createElement('div');
        cmpBar.className = 'bar-fill compare';
        cmpBar.style.width = (s.cmp / maxVal * 100) + '%';

        track.appendChild(baseBar);
        track.appendChild(cmpBar);
        row.appendChild(track);

        totalsEl.appendChild(row);
      });

      // delta chart
      series.forEach(s=>{
        const delta = (s.cmp || 0) - (s.base || 0);
        const row = document.createElement('div');
        row.className = 'bar-row';

        const label = document.createElement('div');
        label.className = 'bar-label';
        label.textContent = s.label;
        row.appendChild(label);

        const track = document.createElement('div');
        track.className = 'bar-track';

        const bar = document.createElement('div');
        bar.className = 'bar-fill';
        bar.style.width = (Math.abs(delta) / maxVal * 100) + '%';
        bar.style.background = delta >= 0 ? '#16a34a' : '#dc2626';

        track.appendChild(bar);
        row.appendChild(track);

        deltaEl.appendChild(row);
      });
    }

    // ---------- Breakdown table ----------
    function updateBreakdown(yoy){
      const tb = $('#yBreakdownBody');
      tb.innerHTML = '';
      const rows = Array.isArray(yoy?.rows) ? yoy.rows : [];
      const metric = state.metric || 'amount';

      if(!rows.length){
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 6;
        td.className = 'text-xs muted';
        td.textContent = 'No rows for selected filters.';
        tr.appendChild(td);
        tb.appendChild(tr);
        return;
      }

      // group by slot+category
      const map = new Map();
      for(const r of rows){
        const key = (r.slotLabel || r.slot || r.slotKey || 'All') + '|' + (r.category || r.cat || 'all');
        const rec = map.get(key) || {
          slotLabel: r.slotLabel || r.slot || r.slotKey || 'All',
          category: r.category || r.cat || 'all',
          base:0, cmp:0
        };
        const year = Number(r.year || r.yr || 0);
        const val = pickMetric(r, metric);
        if(year === state.baseYear) rec.base += val;
        if(year === state.compareYear) rec.cmp += val;
        map.set(key, rec);
      }

      const series = Array.from(map.values()).sort((a,b)=>{
        if(a.slotLabel === b.slotLabel){
          return String(a.category).localeCompare(String(b.category));
        }
        return String(a.slotLabel).localeCompare(String(b.slotLabel));
      });

      for(const s of series){
        const tr = document.createElement('tr');
        const delta = (s.cmp || 0) - (s.base || 0);
        const pctStr = pct(delta, s.base);

        const baseTxt = state.metric === 'amount' ? money(s.base) : (s.base || 0).toLocaleString();
        const cmpTxt  = state.metric === 'amount' ? money(s.cmp) : (s.cmp || 0).toLocaleString();
        const deltaTxt = state.metric === 'amount' ? money(delta) : delta.toLocaleString();

        const pillClass =
          delta > 0 ? 'pill green' :
          delta < 0 ? 'pill red' :
          'pill gray';

        tr.innerHTML = `
          <td class="text-xs">${s.slotLabel}</td>
          <td class="text-xs">${s.category}</td>
          <td class="text-xs text-right">${baseTxt}</td>
          <td class="text-xs text-right">${cmpTxt}</td>
          <td class="text-xs text-right">${deltaTxt}</td>
          <td class="text-xs text-right"><span class="${pillClass}">${pctStr}</span></td>
        `;
        tb.appendChild(tr);
      }
    }

    // ---------- EXPORT + PRINT ----------
    function exportYoYCsv(){
      const yoy = state.yoy;
      const rows = Array.isArray(yoy?.rows) ? yoy.rows : [];
      if(!rows.length){
        alert('No data to export yet.');
        return;
      }
      const metric = state.metric || 'amount';
      const header = [
        'year',
        'slotKey',
        'slotLabel',
        'category',
        'metric',
        'value',
        'orders',
        'purchasers',
        'items'
      ];
      const lines = [header.join(',')];

      for(const r of rows){
        const year = r.year || r.yr || '';
        const slotKey = r.slotKey || r.slot || '';
        const slotLabel = (r.slotLabel || '').replace(/"/g,'""');
        const category = r.category || r.cat || '';

        const value = pickMetric(r, metric);
        const orders = Number(r.orders || r.orderCount || 0);
        const purchasers = Number(r.purchasers || r.buyerCount || 0);
        const items = Number(r.items || r.itemCount || 0);

        const rowCsv = [
          year,
          `"${slotKey}"`,
          `"${slotLabel}"`,
          `"${category}"`,
          metric,
          value,
          orders,
          purchasers,
          items
        ].join(',');
        lines.push(rowCsv);
      }

      const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const today = new Date().toISOString().split('T')[0];
      a.href = url;
      a.download = `amaranth-yoy-${today}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // ---------- Wire events ----------
    document.getElementById('yCategory').addEventListener('change', ()=>{
      state.category = $('#yCategory').value || '';
      loadYoy();
    });
    document.getElementById('ySlot').addEventListener('change', ()=>{
      state.slot = $('#ySlot').value || 'all';
      loadYoy();
    });
    document.getElementById('yBase').addEventListener('change', ()=>{
      state.baseYear = Number($('#yBase').value || 0) || null;
      loadYoy();
    });
    document.getElementById('yCompare').addEventListener('change', ()=>{
      state.compareYear = Number($('#yCompare').value || 0) || null;
      loadYoy();
    });
    document.getElementById('yMetric').addEventListener('change', ()=>{
      state.metric = $('#yMetric').value || 'amount';
      if(state.yoy){
        updateHeadline(state.yoy);
        updateCharts(state.yoy);
        updateBreakdown(state.yoy);
      }
    });

    document.getElementById('btnYoYPrint').addEventListener('click', ()=>{
      window.print();
    });
    document.getElementById('btnYoYExport').addEventListener('click', exportYoYCsv);

    // ---------- Init ----------
    (async function init(){
      await loadIndex();
      await loadYoy();
    })();
  </script>

  <!-- Shared help popup logic -->
  <script src="/assets/js/admin-help.js"></script>
</body>
</html>
