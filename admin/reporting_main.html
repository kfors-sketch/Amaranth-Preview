<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Amaranth Admin — Reporting Dashboard</title>
  <meta name="robots" content="noindex, nofollow" />

  <!-- Shared styles (includes .help-btn and modal styles) -->
  <link rel="stylesheet" href="/assets/css/styles.css" />

  <style>
    *,*::before,*::after{box-sizing:border-box}
    html,body{margin:0;padding:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;background:#f7f7fb;color:#111}
    a{color:inherit;text-decoration:none}
    button{cursor:pointer}
    .hide{display:none}
    .container{max-width:1200px;margin:24px auto;padding:0 16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:14px}
    .card h3{margin:0 0 8px;font-size:15px;color:#374151}
    .card p{margin:4px 0 8px;font-size:13px;color:#4b5563}
    .muted{color:#6b7280;font-size:12px}
    .row{display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap}
    .col{flex:1 1 0;min-width:260px}
    .controls{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
    .controls label{font-size:12px;color:#4b5563}
    .controls input,.controls select{width:100%;height:32px;border-radius:8px;border:1px solid #d1d5db;padding:0 8px;font-size:13px}
    .controls .group{flex:1 1 120px;min-width:120px}
    .btn{height:32px;border-radius:999px;border:1px solid #d1d5db;background:#111;color:#fff;font-size:13px;padding:0 14px;font-weight:600;display:inline-flex;align-items:center;justify-content:center}
    .btn.secondary{background:#fff;color:#111}
    .btn.sm{height:28px;font-size:12px;padding:0 10px}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px;align-items:center}
    .toolbar .spacer{flex:1 1 auto}
    table{width:100%;border-collapse:collapse;font-size:12px}
    th,td{border-bottom:1px solid #e5e7eb;padding:6px 4px;text-align:left;vertical-align:top}
    th{font-size:11px;text-transform:uppercase;letter-spacing:.03em;color:#6b7280;background:#f9fafb;position:sticky;top:0;z-index:1}
    tr:nth-child(even){background:#f9fafb}
    .badge{display:inline-flex;align-items:center;border-radius:999px;border:1px solid #e5e7eb;padding:1px 7px;font-size:11px;color:#374151;background:#f9fafb}
    .pill{display:inline-flex;align-items:center;border-radius:999px;padding:2px 8px;font-size:11px;border:1px solid #e5e7eb;background:#f9fafb}
    .pill.green{border-color:#16a34a;color:#166534;background:#ecfdf3}
    .pill.red{border-color:#dc2626;color:#b91c1c;background:#fef2f2}
    .pill.orange{border-color:#ea580c;color:#9a3412;background:#fff7ed}
    .tag-muted{background:#f3f4f6;color:#4b5563;border-color:#e5e7eb}
    .flex{display:flex}
    .flex.between{justify-content:space-between;align-items:center}
    .flex.gap-8{gap:8px}
    .mt-8{margin-top:8px}
    .mt-12{margin-top:12px}
    .mt-4{margin-top:4px}
    .text-right{text-align:right}
    .nowrap{white-space:nowrap}
    .w-100{width:100%}
    .chip{display:inline-flex;align-items:center;border-radius:999px;border:1px solid #e5e7eb;padding:2px 8px;font-size:11px;background:#f9fafb;color:#374151;margin-right:4px;margin-bottom:4px}
    .chip span{opacity:.7;margin-left:4px}
    .badge-dot{width:6px;height:6px;border-radius:999px;margin-right:4px}
    .badge-dot.green{background:#16a34a}
    .badge-dot.red{background:#ef4444}
    .badge-dot.gray{background:#9ca3af}
    .status-icon{font-size:11px;border-radius:999px;border:1px solid #e5e7eb;padding:0 6px;display:inline-flex;align-items:center;gap:3px}
    .status-icon span.dot{width:6px;height:6px;border-radius:999px;background:#9ca3af}
    .status-icon.paid span.dot{background:#16a34a}
    .status-icon.refunded span.dot{background:#ef4444}
    .status-icon.pending span.dot{background:#f97316}
    .table-wrap{max-height:480px;overflow:auto;border-radius:12px;border:1px solid #e5e7eb;background:#fff}
    .badge-sm{font-size:11px;padding:1px 6px;border-radius:999px;border:1px solid #e5e7eb;background:#f9fafb;color:#4b5563}
    .text-sm{font-size:12px}
    .text-xs{font-size:11px}
    .mb-4{margin-bottom:4px}
    .mb-8{margin-bottom:8px}
    .mb-12{margin-bottom:12px}
    .mb-16{margin-bottom:16px}
    .border-top{border-top:1px solid #e5e7eb;margin-top:8px;padding-top:8px}
    .right-controls{display:flex;flex-wrap:wrap;gap:8px}
    .right-controls .group{min-width:120px}
    .pill-blue{border-color:#2563eb;color:#1d4ed8;background:#eff6ff}
    .section-label{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.06em;color:#6b7280;margin-bottom:4px}
    .heading-row{display:flex;justify-content:space-between;align-items:flex-end;gap:8px;margin-bottom:12px}
    .heading-row h2{
      margin:0;
      font-size:20px;
      color:#111827;
      display:flex;
      align-items:center;
      gap:6px;
      flex-wrap:wrap;
    }
    .heading-row .muted{font-size:12px;max-width:420px}
    .heading-actions{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:flex-end}
    @media (max-width:768px){
      .row{flex-direction:column}
      .table-wrap{max-height:none}
      .heading-row{flex-direction:column;align-items:flex-start}
      .heading-actions{justify-content:flex-start}
    }

    #refundModal{position:fixed;inset:0;background:rgba(15,23,42,.5);display:none;align-items:center;justify-content:center;z-index:50}
    #refundModal[aria-hidden="false"]{display:flex}
    #refundModal .modal-inner{background:#fff;border-radius:16px;box-shadow:0 20px 40px rgba(15,23,42,.25);max-width:420px;width:100%;padding:16px}
    #refundModal h4{margin:0 0 8px;font-size:16px}
    #refundModal p{margin:0 0 8px;font-size:13px}
    #refundModal .modal-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
  
    /* Two-column layout for the Test + Receipts ZIP cards */
    .two-col-cards{
      display:flex;
      gap:16px;
      flex-wrap:wrap;
      align-items:stretch;
      margin-top:16px;
    }
    .two-col-cards > .card,
    .two-col-cards > section.card{
      flex:1 1 420px;
      max-width:calc(50% - 8px);
    }
    @media (max-width: 980px){
      .two-col-cards > .card,
      .two-col-cards > section.card{
        max-width:100%;
      }
    }
</style>
</head>
<body>
  <div class="container">
    <div class="heading-row">
      <div>
        <h2>
          Reporting Dashboard
          <button
            type="button"
            class="help-btn"
            data-help-id="reporting_main"
            aria-label="Help for Reporting Dashboard"
            onclick="window.showAdminHelp && window.showAdminHelp('reporting_main')"
          >?</button>
        </h2>
        <p class="muted">Download, email, and inspect registration data. Filters at the top affect most exports.</p>
      </div>
      <div class="heading-actions">
        <!-- Match the two link-style buttons from admin/banquets.html -->
        <a href="index.html" class="btn secondary sm">← Admin Hub</a>
        <a href="banquets.html" class="btn secondary sm">Banquet Manager</a>
        <button id="btnPrint" class="btn secondary sm">Print</button>
      </div>
    </div>

    <!-- Top filters + tools -->
    <div class="card mb-16">
      <div class="flex between mb-4">
        <div class="section-label">Filters &amp; tools</div>
        <button
          type="button"
          class="help-btn"
          data-help-id="reporting_filters"
          aria-label="Help for Filters and Tools"
        >?</button>
      </div>

      <div class="toolbar">
        <div class="group">
          <label class="muted">From date</label>
          <input id="dateFrom" type="date" />
        </div>
        <div class="group">
          <label class="muted">To date</label>
          <input id="dateTo" type="date" />
        </div>
        <div class="group">
          <label class="muted">Category</label>
          <select id="category">
            <option value="">All</option>
            <option value="banquet">Banquets</option>
            <option value="addon">Add-ons</option>
            <option value="catalog">Catalog</option>
          </select>
        </div>
        <div class="group">
          <label class="muted">Status</label>
          <select id="status">
            <option value="">Any</option>
            <option value="paid">Paid</option>
            <option value="pending">Pending</option>
            <option value="refunded">Refunded</option>
          </select>
        </div>
        <div class="group w-100" style="max-width:220px">
          <label class="muted">Search (name, email, item…)</label>
          <input id="search" type="text" placeholder="Search text…" />
        </div>
        <div class="spacer"></div>
        <div class="right-controls">
          <button id="btnExportCsv" class="btn sm">Export Filtered (.xlsx)</button>
          <button id="btnFullAttendeesCsv" class="btn sm secondary">Full Attendee List</button>
          <button id="btnSample" class="btn sm secondary">Load Sample</button>
          <button id="btnClear" class="btn sm secondary">Clear Local</button>
        </div>
      </div>
      <p class="muted mt-4">These controls affect what you see in the table below and most downloads. Server data is never deleted from this page—only your local cache.</p>
    </div>

        <div class="row" style="margin-top:16px;">
      <div class="col" style="flex: 1 1 480px; max-width: 560px;">
        <div class="card mb-12">
      <div class="section-label">Testing</div>
      <h3>Send Test Chair Report Emails</h3>
      <p class="muted">
        Send the same chair report emails using <strong>live orders</strong>, but only to your test address.
        This does <strong>not</strong> affect scheduled chair emails.
      </p>

      <div class="controls mt-4">
        <div class="group" style="max-width:320px">
          <label class="muted">Send to</label>
          <input id="testReportTo" type="email" value="kfors@verizon.net" />
        </div>

        <div class="group" style="max-width:220px">
          <label class="muted">Frequency</label>
          <select id="testReportFreq">
            <option value="daily">Daily</option>
            <option value="weekly">Weekly</option>
            <option value="biweekly">Biweekly</option>
            <option value="monthly" selected>Monthly</option>
            <option value="all">All</option>
          </select>
        </div>

        <div class="group" style="max-width:220px">
          <label class="muted">Scope</label>
          <select id="testReportScope">
            <option value="current-month" selected>Current month</option>
            <option value="full">Full history</option>
          </select>
        </div>
        <div class="group" style="max-width:220px">
          <label class="muted">Preview only</label>
          <div style="height:32px;display:flex;align-items:center;gap:8px;">
            <input id="testPreviewOnly" type="checkbox" />
            <span class="muted">No email</span>
          </div>
        </div>

        <div class="group" style="max-width:200px">
          <label class="muted">&nbsp;</label>
          <button id="btnSendTestReports" class="btn sm w-100">Run Test Now</button>
        </div>
      </div>

      <pre id="testReportOut" class="mt-8"
           style="background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:8px;font-size:11px;white-space:pre-wrap;"></pre>
    </div>
      </div>
      <div class="col" style="flex: 1 1 480px; max-width: 560px;">
        <section class="card" style="margin-top:16px;">
  <h3>Receipts ZIP — Auto Send Options</h3>
  <p class="muted" style="margin-top:6px;">
    Uses the selected <strong>Report Channel</strong> (below) or falls back to the <strong>Order Channel</strong> in Admin Settings (<code id="orderChannelLabel">…</code>) to decide whether it’s pulling from Stripe TEST vs LIVE.
  </p>

  <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end;margin-top:10px;">
    <div style="min-width:220px;">
      <label class="muted">Report Channel (Chair Reports &amp; Receipts ZIP)</label>
      <select id="reportChannel" style="width:100%;height:32px;border-radius:8px;border:1px solid #d1d5db;padding:0 8px;font-size:13px">
        <option value="auto" selected>Auto (use Order Channel)</option>
        <option value="test">Test</option>
        <option value="live_test">Live-Test</option>
        <option value="live">Live</option>
      </select>
    </div>
  </div>

  <div style="display:flex;gap:18px;flex-wrap:wrap;align-items:flex-start;margin-top:10px;">
    <label style="display:flex;gap:8px;align-items:center;">
      <input type="checkbox" id="zipMonthly" />
      <span>Monthly (previous month)</span>
    </label>

    <label style="display:flex;gap:8px;align-items:center;">
      <input type="checkbox" id="zipWeekly" />
      <span>Weekly (previous full week, UTC)</span>
    </label>

    <button class="btn" id="btnSaveZipPrefs" style="margin-left:auto;">Save</button>
  </div>

  <div class="muted" id="zipPrefsStatus" style="margin-top:10px;"></div>
</section>
      </div>
    </div>

<div class="row">
      <div class="col">
        <div class="card">
          <div class="flex between mb-8">
            <div>
              <div class="section-label">Overview</div>
              <h3>
                Orders &amp; Payments
                <button
                  type="button"
                  class="help-btn"
                  data-help-id="reporting_orders"
                  aria-label="Help for Orders and Payments"
                >?</button>
              </h3>
              <p class="muted">Filtered by the controls above. Click a row for refund tools.</p>
            </div>
            <div class="text-right">
              <div class="badge">
                <span id="totalCount">0</span>&nbsp; rows
              </div>
              <div class="mt-4">
                <label for="rowsLimit" class="muted text-xs">Rows shown</label><br/>
                <select id="rowsLimit" class="text-xs" style="margin-top:2px;height:24px;border-radius:999px;border:1px solid #d1d5db;padding:0 6px;">
                  <option value="10">10</option>
                  <option value="15" selected>15</option>
                  <option value="25">25</option>
                  <option value="50">50</option>
                  <option value="all">All</option>
                </select>
              </div>
              <div class="mt-4 text-xs muted">
                Total: <strong id="totalAmount">$0.00</strong><br/>
                Paid: <span id="paidCount">0</span> • Pending: <span id="pendingCount">0</span> • Refunded: <span id="refundedCount">0</span>
              </div>
            </div>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>#</th>
                  <th>Date</th>
                  <th>Buyer</th>
                  <th>Item</th>
                  <th>Category</th>
                  <th>Status</th>
                  <th class="text-right">Amount</th>
                  <th>Meta</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="col">
        <div class="card mb-12">
          <div class="section-label">Local Tools</div>
          <h3>
            Import / Export
            <button
              type="button"
              class="help-btn"
              data-help-id="reporting_import"
              aria-label="Help for Import and Export"
            >?</button>
          </h3>
          <p class="muted">Work offline by importing .json or .csv. This never overwrites data on the server.</p>
          <div class="controls mt-4">
            <div class="group">
              <label class="muted">Import from file</label>
              <input id="fileImport" type="file" accept=".json,.csv" />
            </div>
          </div>
          <p class="muted mt-4">Use “Export Filtered (.xlsx)” above to download directly from the server with all filters applied.</p>
        </div>

        <!-- WEEKLY-ONLY AUTOMATION -->
        <div class="card mb-12">
          <div class="section-label">Automation</div>
          <h3>
            Automated Chair Reports
            <button
              type="button"
              class="help-btn"
              data-help-id="reporting_automation"
              aria-label="Help for Automated Chair Reports"
            >?</button>
          </h3>
          <p class="muted">
            Reports are sent <strong>weekly</strong> to banquet, add-on, and catalog chairs on the day you choose below.
          </p>

          <div class="controls mt-4">
            <div class="group">
              <label class="muted">Weekly send day</label>
              <select id="reportWeekday">
                <option value="1">Monday</option>
                <option value="2">Tuesday</option>
                <option value="3">Wednesday</option>
                <option value="4">Thursday</option>
                <option value="5">Friday</option>
                <option value="6">Saturday</option>
                <option value="7">Sunday</option>
              </select>
            </div>
          </div>

          <div class="controls mt-4">
            <div class="group" style="max-width:180px">
              <button id="btnSaveReportSettings" class="btn sm">Save Settings</button>
            </div>
            <div class="group">
              <span id="reportSettingsStatus" class="muted"></span>
            </div>
          </div>

          <p class="muted mt-4" id="reportSettingsHelp"></p>
        </div>

        <!-- Item tools -->
        <div class="card mb-12">
          <div class="section-label">Per-item tools</div>
          <h3>
            Download / Email by Specific Item
            <button
              type="button"
              class="help-btn"
              data-help-id="reporting_item_tools"
              aria-label="Help for Per-item Tools"
            >?</button>
          </h3>
          <p class="muted">Pick a category and item to download a focused report or email the chair directly.</p>

          <div class="controls mt-4">
            <div class="group">
              <label class="muted">Category</label>
              <select id="actCategory">
                <option value="" selected disabled>Choose…</option>
                <option value="banquet">Banquets</option>
                <option value="addon">Add-ons</option>
                <option value="other">Catalog</option>
              </select>
            </div>
            <div class="group">
              <label class="muted">Item</label>
              <select id="actChoice">
                <option value="" selected disabled>Choose…</option>
              </select>
            </div>
          </div>

          <div class="controls mt-4">
            <div class="group">
              <label class="muted">Email scope</label>
              <select id="scopeMode">
                <option value="full">Full (all orders for this item)</option>
                <option value="current-month">Month-to-date (from the 1st)</option>
                <option value="custom">Custom date range</option>
              </select>
            </div>
          </div>

          <div class="controls mt-4" id="scopeRangeRow" style="display:none">
            <div class="group">
              <label class="muted">Start date</label>
              <input id="scopeStart" type="date" />
            </div>
            <div class="group">
              <label class="muted">End date</label>
              <input id="scopeEnd" type="date" />
            </div>
          </div>

          <div class="controls mt-4">
            <div class="group" style="max-width:200px">
              <button id="btnActDownload" class="btn sm secondary">Download .xlsx</button>
            </div>
            <div class="group" style="max-width:200px">
              <button id="btnActEmail" class="btn sm">Email Chair(s)</button>
            </div>
          </div>
          <p class="muted mt-4" id="sendMsg"></p>
        </div>

        <div class="card">
          <div class="section-label">Quick totals</div>
          <h3>
            By Category
            <button
              type="button"
              class="help-btn"
              data-help-id="reporting_totals"
              aria-label="Help for Category Totals"
            >?</button>
          </h3>
          <p class="muted">Rough totals for the current filter window. For full accounting, use the exports above.</p>
          <div id="totalsByCategory" class="mt-8 text-sm muted"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Refund Modal -->
  <div id="refundModal" aria-hidden="true">
    <div class="modal-inner">
      <h4>Issue Refund</h4>
      <p class="muted">Create a Stripe refund for this payment.</p>
      <div class="mt-8">
        <label class="muted">Type</label>
        <select id="rfType" class="w-100" style="height:32px;border-radius:8px;border:1px solid #d1d5db;padding:0 8px;font-size:13px">
          <option value="full">Full refund</option>
          <option value="partial">Partial amount</option>
        </select>
      </div>
      <div class="mt-4" id="rfAmtWrap" style="display:none">
        <label class="muted">Amount (USD)</label>
        <input id="rfAmount" type="number" min="0" step="0.01" class="w-100" style="height:32px;border-radius:8px;border:1px solid #d1d5db;padding:0 8px;font-size:13px" />
      </div>
      <p class="muted mt-4" id="rfInfo"></p>
      <div class="modal-actions">
        <button id="rfCancel" class="btn secondary sm">Cancel</button>
        <button id="rfSubmit" class="btn sm">Refund</button>
      </div>
    </div>
  </div>

  
    <!-- TEST CHAIR REPORT EMAILS -->
    <script>
    const LS_KEY = 'amaranth-report-rows-v1';
    let rows = [];

    function $(sel){
  const el = document.querySelector(sel);
  if (el) return el;

  // Safe fallback: prevents the whole dashboard from crashing if a control is temporarily removed/renamed.
  // Missing elements become no-op proxies (addEventListener, textContent, innerHTML, etc.).
  return new Proxy({}, {
    get(_t, prop){
      if (prop === 'addEventListener' || prop === 'removeEventListener') return () => {};
      if (prop === 'classList') return { add(){}, remove(){}, toggle(){} };
      if (prop === 'style') return {};
      return undefined;
    },
    set(_t, _prop, _value){ return true; }
  });
}

async function loadZipPrefs() {
  const status = document.getElementById("zipPrefsStatus");
  try {
    const r = await fetch("/api/router?type=receipts_zip_prefs", { headers: Admin.tokenHeader() });
    const j = await r.json();
    const payload = j?.json || j;
    const prefs = payload?.prefs || {};
    const channel = String(payload?.channel || 'auto');
    const resolvedMode = String(payload?.resolvedMode || '');
    const monthly = !!prefs.monthly;
    const weekly = !!prefs.weekly;
    const mEl = document.getElementById("zipMonthly");
    const wEl = document.getElementById("zipWeekly");
    if (mEl) mEl.checked = monthly;
    if (wEl) wEl.checked = weekly;
    const chEl = document.getElementById('reportChannel');
    if (chEl) chEl.value = (channel === 'live-test' ? 'live_test' : channel);
    if (status) status.textContent = resolvedMode ? `Loaded. Using: ${resolvedMode}` : 'Loaded.';
  } catch (e) {
    if (status) status.textContent = "Could not load (check admin token).";
  }
}

async function saveZipPrefs() {
  const status = document.getElementById("zipPrefsStatus");
  const monthly = !!document.getElementById("zipMonthly")?.checked;
  const weekly = !!document.getElementById("zipWeekly")?.checked;
  const channel = String(document.getElementById('reportChannel')?.value || 'auto');
  try {
    if (status) status.textContent = "Saving…";
    const r = await fetch("/api/router?action=set_receipts_zip_prefs", {
      method: "POST",
      headers: { "Content-Type": "application/json", ...Admin.tokenHeader() },
      body: JSON.stringify({ monthly, weekly, channel })
    });
    const j = await r.json();
    if (!j?.ok && !j?.json?.ok) throw new Error("save failed");
    if (status) status.textContent = `Saved. Monthly=${monthly ? "on" : "off"}, Weekly=${weekly ? "on" : "off"}.`;
  } catch (e) {
    if (status) status.textContent = "Save failed (check admin token).";
  }
}

document.getElementById("btnSaveZipPrefs")?.addEventListener("click", saveZipPrefs);
loadOrderChannelLabel();
loadZipPrefs();

</script>
</body>
</html>
