<!-- Please place the Send Now block into your reporting_main.html -->
<!-- Send Now (email) --> 
<div class="card">
  <h3>Send Report Now</h3>
  <div class="controls">
    <input id="sendTo" class="input" type="email" placeholder="chairperson@example.com" style="min-width:260px">
    <select id="sendScope" title="Scope">
      <option value="current" selected>Current (visible filters)</option>
      <option value="full">Full (all rows)</option>
    </select>
    <button id="btnSendNow" class="btn success">Send Now</button>
    <span id="sendStatus" class="muted"></span>
  </div>
</div>

<script>
// Send Now logic (resend via /api/admin/send-report)
const sendStatus = document.getElementById('sendStatus');
document.getElementById('btnSendNow').addEventListener('click', async () => {
  const to = document.getElementById('sendTo').value.trim();
  const scope = document.getElementById('sendScope').value;
  if (!to) { sendStatus.textContent = 'Enter a recipient email.'; sendStatus.style.color = 'crimson'; return; }

  // Build CSV from current or full data
  const headers = ['date','orderId','purchaser','attendee','category','item','qty','price','gross','fees','net','status','notes'];
  const data = scope === 'current' ? applyFilters(rows) : rows;
  const exportRows = data.map(r => ({
    date: r.date ? new Date(r.date).toISOString() : '',
    orderId: r.id,
    purchaser: r.purchaser || '',
    attendee: r.attendee || '',
    category: r.category || '',
    item: r.item || '',
    qty: r.qty ?? 1,
    price: Number(r.price || 0).toFixed(2),
    gross: Number(r.gross || 0).toFixed(2),
    fees: Number(r.fees || 0).toFixed(2),
    net: Number(r.net || ((r.gross||0)-(r.fees||0))).toFixed(2),
    status: r.status || '',
    notes: r.notes || ''
  }));
  const csv = rowsToCSV(headers, exportRows);

  sendStatus.textContent = 'Sendingâ€¦'; sendStatus.style.color = '#6b7280';
  try {
    const resp = await fetch('/api/admin/send-report', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        to, scope,
        subject: scope === 'full' ? 'Amaranth Full Report' : 'Amaranth Current Report',
        csv
      })
    });
    const json = await resp.json();
    if (!resp.ok) throw new Error(json?.error || 'Send failed');
    sendStatus.textContent = 'Email sent.'; sendStatus.style.color = '#065f46';
  } catch (e) {
    sendStatus.textContent = 'Failed: ' + e.message; sendStatus.style.color = 'crimson';
  }
});
</script>
