<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Amaranth Admin — Reporting Dashboard</title>
  <meta name="robots" content="noindex, nofollow" />
  <link rel="stylesheet" href="/assets/css/styles.css" />
</head>
<body>
  <div class="container">

    <!-- ================= REPORT / EMAIL CONTROLS ================= -->
    <div class="card mb-16">
      <div class="section-label">Email & Report Controls</div>
      <h3>Reporting Data & Automation</h3>
      <p class="muted">These settings control which orders are used when emails are sent. Checkout behavior is not affected.</p>

      <div class="controls mt-8">
        <div class="group" style="max-width:220px">
          <label class="muted">Report data source</label>
          <select id="reportDataSource">
            <option value="auto">Auto (follow checkout mode)</option>
            <option value="live">Live only</option>
            <option value="live_test">Live-test only</option>
            <option value="test">Test only</option>
          </select>
        </div>

        <div class="group" style="max-width:160px">
          <label class="muted">Chair reports</label>
          <select id="chairReportsEnabled">
            <option value="on">Enabled</option>
            <option value="off">Off</option>
          </select>
        </div>
      </div>

      <div class="controls mt-8">
        <div class="group" style="max-width:180px">
          <label class="muted">Receipts ZIP</label>
          <select id="receiptsZipMode">
            <option value="off">Off</option>
            <option value="monthly">Monthly</option>
            <option value="weekly">Weekly</option>
            <option value="both">Weekly + Monthly</option>
          </select>
        </div>

        <div class="group" style="max-width:160px">
          <label class="muted">&nbsp;</label>
          <button id="btnSaveReportSwitches" class="btn sm">Save</button>
        </div>

        <div class="group">
          <span id="reportSwitchStatus" class="muted"></span>
        </div>
      </div>
    </div>

    <p class="muted">All other reporting tools remain unchanged.</p>
  </div>

<script>
  function getAuthHeaders(){
    const token = localStorage.getItem('amaranth_report_token') || '';
    const h = { 'Content-Type': 'application/json' };
    if (token) h.Authorization = 'Bearer ' + token;
    return h;
  }

  async function loadReportSwitches(){
    const status = document.getElementById('reportSwitchStatus');
    try{
      const r = await fetch('/api/router?type=reports_settings',{ headers:getAuthHeaders() });
      const j = await r.json();
      if(!r.ok) throw new Error();

      const s = j.settings || {};
      document.getElementById('reportDataSource').value = s.orderChannel || 'auto';
      document.getElementById('chairReportsEnabled').value = s.chairReportsEnabled===false ? 'off' : 'on';

      const rz = s.receiptsZip || {};
      let mode = 'off';
      if (rz.monthlyEnabled && rz.weeklyEnabled) mode='both';
      else if (rz.weeklyEnabled) mode='weekly';
      else if (rz.monthlyEnabled) mode='monthly';
      document.getElementById('receiptsZipMode').value = mode;

      status.textContent = '';
    }catch{
      status.textContent = 'Failed to load report settings.';
    }
  }

  document.getElementById('btnSaveReportSwitches').addEventListener('click', async ()=>{
    const status = document.getElementById('reportSwitchStatus');
    status.textContent = 'Saving…';

    const orderChannel = document.getElementById('reportDataSource').value;
    const chairOn = document.getElementById('chairReportsEnabled').value === 'on';
    const zipMode = document.getElementById('receiptsZipMode').value;

    const payload = {
      orderChannel,
      chairReportsEnabled: chairOn,
      receiptsZip: {
        monthlyEnabled: zipMode === 'monthly' || zipMode === 'both',
        weeklyEnabled: zipMode === 'weekly' || zipMode === 'both'
      }
    };

    try{
      const r = await fetch('/api/router?action=reports_settings_set',{
        method:'POST',
        headers:getAuthHeaders(),
        body:JSON.stringify(payload)
      });
      const j = await r.json();
      if(!r.ok) throw new Error(j?.error||'Save failed');
      status.textContent = 'Saved.';
    }catch(e){
      status.textContent = 'Save failed.';
    }
  });

  loadReportSwitches();
</script>
</body>
</html>
