<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Banquet Manager — Amaranth</title>
  <meta name="robots" content="noindex, nofollow" />
  <link rel="stylesheet" href="/assets/css/styles.css" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f7f7fb;color:#111;margin:0}
    .container{max-width:1200px;margin:24px auto;padding:0 16px}
    .row{display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap}
    .col{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:14px}
    .col.left{flex:2 1 640px;min-width:520px}
    .col.right{flex:1 1 480px;min-width:420px;position:sticky;top:16px}
    h1{margin:0 0 10px}
    .pill{display:inline-flex;align-items:center;gap:6px;background:#eef2ff;color:#3730a3;font-weight:600;font-size:12px;border-radius:999px;padding:6px 10px}
    .btn{height:36px;border:1px solid #d1d5db;background:#111;color:#fff;border-radius:10px;padding:0 12px;font-weight:700;cursor:pointer}
    .btn.ghost{background:#fff;color:#111}
    .btn.warn{background:#b91c1c;border-color:#991b1b}
    .btn.success{background:#065f46;border-color:#064e3b}
    input,select,textarea{width:100%;border:1px solid #d1d5db;border-radius:10px;padding:8px;background:#fff}
    textarea{min-height:80px}
    label{font-weight:600;margin-top:8px;display:block}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{background:#fafafa;border-bottom:1px solid #e5e7eb;color:#6b7280;font-size:12px;letter-spacing:.04em;text-transform:uppercase;padding:10px;text-align:left;position:sticky;top:0}
    tbody td{padding:10px;border-bottom:1px solid #f1f2f6;vertical-align:top}
    .muted{color:#6b7280}
    .rules{background:#f9fafb;border:1px dashed #d1d5db;border-radius:12px;padding:10px;margin:8px 0 12px}
    .chip{display:inline-block;border-radius:999px;padding:3px 8px;background:#eef2ff;color:#3730a3;font-weight:600;font-size:12px;margin-right:6px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .right .toolbar{margin-bottom:8px}
    .hint{font-size:12px;color:#6b7280;margin-top:4px}
    .danger{color:#b91c1c}
    .ok{color:#065f46}
    code{background:#f3f4f6;border:1px solid #e5e7eb;border-radius:6px;padding:1px 6px}
  </style>
</head>
<body>
<main class="container">
<header style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
  <div>
    <h1>Banquet Manager</h1>
    <div class="muted">Active banquets only — archived remain available in YoY history</div>
  </div>
  <div style="display:flex;gap:8px">
    <a class="btn ghost" href="/admin/index.html">← Admin Hub</a>
    <button id="logoutBtn" class="btn ghost">Log Out</button>
  </div>
</header>

<section class="col rules">
  <strong>Rules & Tips</strong>
  <ul class="muted" style="margin:8px 0 0 16px">
    <li><b>Sort Order</b>: lower numbers appear first (admin + public)</li>
    <li><b>Archive</b>: hides from admin/public but keeps YoY data</li>
  </ul>
</section>

<div class="row">
<section class="col left">
  <div class="toolbar">
    <button id="btnAddNew" class="btn success">+ New Banquet</button>
    <button id="btnRefresh" class="btn ghost">Refresh</button>
    <span id="listMsg" class="muted"></span>
  </div>

  <div style="overflow:auto;max-height:65vh;margin-top:8px">
    <table>
      <thead>
        <tr>
          <th>Sort</th>
          <th>Name</th>
          <th>ID</th>
          <th>Event</th>
          <th>Active</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</section>

<aside class="col right">
  <div class="toolbar">
    <span class="chip" id="modeChip">New</span>
    <span id="editMsg" class="muted"></span>
  </div>

  <label>Name</label>
  <input id="f_name" />

  <label>ID</label>
  <input id="f_id" />

  <label>Sort Order</label>
  <input id="f_sort" type="number" value="1000" />
  <div class="hint">Lower = shows earlier</div>

  <label>Event Date</label>
  <input id="f_eventAt" type="datetime-local" />

  <label>Active</label>
  <select id="f_active">
    <option value="true">true</option>
    <option value="false">false</option>
  </select>

  <div class="toolbar" style="margin-top:10px">
    <button id="btnSave" class="btn">Save</button>
    <button id="btnReset" class="btn ghost">Reset</button>
  </div>
</aside>
</div>
</main>

<script src="/assets/js/admin.js"></script>

<script>
const $ = s => document.querySelector(s);
let modelAll = [];
let current = null;
let isNew = true;

function normalize(b){
  return {
    ...b,
    active: b.active !== false,
    sortOrder: Number.isFinite(+b.sortOrder) ? +b.sortOrder : 1000
  };
}

function viewList(){
  return modelAll
    .filter(b => b.active !== false)
    .sort((a,b)=>{
      if(a.sortOrder !== b.sortOrder) return a.sortOrder - b.sortOrder;
      return new Date(a.eventAt||0) - new Date(b.eventAt||0);
    });
}

function render(){
  const tb = $('#tbody');
  tb.innerHTML = '';
  viewList().forEach(b=>{
    tb.innerHTML += `
      <tr>
        <td>${b.sortOrder}</td>
        <td>${b.name}</td>
        <td><code>${b.id}</code></td>
        <td>${b.eventAt ? new Date(b.eventAt).toLocaleString() : '—'}</td>
        <td>${b.active ? 'true' : 'false'}</td>
        <td>
          <button onclick="edit('${b.id}')">Edit</button>
          <button onclick="archive('${b.id}')">Archive</button>
        </td>
      </tr>`;
  });
}

function edit(id){
  current = modelAll.find(b=>b.id===id);
  isNew = false;
  $('#modeChip').textContent = 'Edit';
  $('#f_name').value = current.name;
  $('#f_id').value = current.id;
  $('#f_sort').value = current.sortOrder;
  $('#f_eventAt').value = current.eventAt?.slice(0,16)||'';
  $('#f_active').value = String(current.active);
}

function reset(){
  isNew = true;
  current = null;
  $('#modeChip').textContent = 'New';
  $('#f_name').value='';
  $('#f_id').value='';
  $('#f_sort').value='1000';
  $('#f_eventAt').value='';
  $('#f_active').value='true';
}

async function save(){
  const o = {
    id: $('#f_id').value.trim(),
    name: $('#f_name').value.trim(),
    sortOrder: +$('#f_sort').value || 1000,
    eventAt: $('#f_eventAt').value ? new Date($('#f_eventAt').value).toISOString() : '',
    active: $('#f_active').value === 'true'
  };

  if(isNew) modelAll.push(o);
  else Object.assign(current,o);

  render();
  await fetch('/api/router?action=save_banquets',{
    method:'POST',
    headers:{'Content-Type':'application/json',...Admin.tokenHeader()},
    body:JSON.stringify({banquets:modelAll})
  });
}

async function archive(id){
  const b = modelAll.find(x=>x.id===id);
  if(!confirm(`Archive ${b.name}?`)) return;
  b.active = false;
  await save();
}

$('#btnSave').onclick = save;
$('#btnReset').onclick = reset;
$('#btnAddNew').onclick = reset;

(async()=>{
  const r = await fetch('/api/router?type=banquets',{cache:'no-store'});
  const j = await r.json();
  modelAll = (j.banquets||[]).map(normalize);
  render();
})();
</script>
</body>
</html>
