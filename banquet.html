<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Banquets and related items for registration.">
  <link rel="icon" href="assets/img/favicon.svg" type="image/svg+xml">
  <link rel="stylesheet" href="assets/css/styles.css?v=bg2-layers">
  <title>Banquets</title>
</head>

<body data-page="banquets">
  <!-- Header / Logo + Nav -->
  <header class="site-header">
    <div class="container header-inner">
      <a class="logo" href="home.html">
        <img src="assets/img/logo.svg" alt="Logo">
        <span>Order of the Amaranth</span>
      </a>
      <!-- Order: Home | Banquets | Product Catalog | Order -->
      <nav class="site-nav nav">
        <a href="home.html">Home</a>
        <span class="nav-current">Banquets</span>
        <a href="product-catalog.html">Product Catalog</a>
        <a href="order.html">Order</a>
        <!-- (Admin intentionally omitted from header) -->
      </nav>
    </div>
  </header>

  <main class="container mt-lg">
    <h1 class="page-title">Banquets</h1>

    <!-- (Optional) if you later render a grid of banquet cards here) -->
    <div id="banquet-list" class="grid-2"></div>

    <section class="panel">
      <h2>Attendees</h2>
      <form id="attForm" class="att-form">
        <input name="name" placeholder="Name" required>
        <input name="email" type="email" placeholder="Email">
        <input name="title" placeholder="Title">
        <button type="submit">Add attendee</button>
      </form>
      <div id="attendees"></div>
    </section>

    <section class="panel">
      <h2>Banquets</h2>
      <div id="banquets"></div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container tiny">© 2025</div>
  </footer>

  <!-- Optional legacy scripts (keep if used elsewhere) -->
  <script src="assets/js/main.js" defer></script>
  <script src="assets/js/render-multi.js" defer></script>

<script>
document.addEventListener('DOMContentLoaded', function(){
  Cart.load();

  // ----- Attendees block -----
  const list = document.getElementById('attendees');
  const form = document.getElementById('attForm');

  function renderAttendees(){
    const st = Cart.get();
    list.innerHTML = st.attendees.map(a=>`
      <div class="att-card">
        <strong>${a.name||''}</strong> <small>${a.email||''}</small> <em>${a.title||''}</em>
        <button data-del="${a.id}">Remove</button>
      </div>
    `).join('');
    list.querySelectorAll('button[data-del]').forEach(btn=>{
      btn.onclick = () => {
        Cart.removeAttendee(btn.dataset.del);
        renderAttendees();
        refreshAllAttendeeSelects();     // keep selects in sync on delete too
      };
    });
  }

  // Helper: refill a given select with current attendees (with placeholder)
  function populateSelectWithAttendees(sel){
    const a = (Cart.get() || {}).attendees || [];
    sel.innerHTML = '';

    if (!a.length){
      sel.disabled = true;
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = 'Add attendee first';
      sel.appendChild(opt);
    } else {
      sel.disabled = false;
      const ph = document.createElement('option');
      ph.value = '';
      ph.textContent = 'Select attendee…';
      ph.disabled = true;
      ph.selected = true;
      sel.appendChild(ph);

      a.forEach(at=>{
        const opt = document.createElement('option');
        opt.value = at.id;
        opt.textContent = at.name || at.email;
        sel.appendChild(opt);
      });
    }

    // Fire change so any button-enable logic reacts immediately
    sel.dispatchEvent(new Event('change', { bubbles: true }));
  }

  // Helper: update all attendee selects in banquet cards
  function refreshAllAttendeeSelects(){
    document.querySelectorAll('.assign select').forEach(populateSelectWithAttendees);
  }

  form.onsubmit = (e)=>{
    e.preventDefault();
    const fd = new FormData(form);
    Cart.addAttendee({
      name: fd.get('name'),
      email: fd.get('email'),
      title: fd.get('title')
    });
    form.reset();
    renderAttendees();
    refreshAllAttendeeSelects();  // <-- make the dropdowns update immediately
  };

  renderAttendees();

  // ----- Banquets block -----
  const wrap = document.getElementById('banquets');

  function attendeeSelect(){
    const s = document.createElement('select');
    populateSelectWithAttendees(s); // always use the helper above
    return s;
  }

  function addBanquet(b){
    if (b.active === false) return;

    const div = document.createElement('div');
    div.className = 'banquet-card';

    // Base content (showing location) — meal/notes added below if applicable
    div.innerHTML = `
      <h3>${b.name}</h3>
      <div><small>${b.datetime || ''}</small></div>
      ${b.location ? `<div><small><em>${b.location}</em></small></div>` : ``}
      <p>${b.description || ''}</p>

      <label>Ticket:
        <select class="opt"></select>
      </label>

      <div class="meal"></div>   <!-- required radios if mealChoices exist -->
      <div class="notes"></div>  <!-- free-text notes only -->

      <div class="assign"></div>
      <button class="add" disabled>Add to Order</button>
    `;

    // Ticket options (label "Ticket")
    const optSel = div.querySelector('.opt');
    (b.options || []).forEach(o=>{
      const op = document.createElement('option');
      op.value = JSON.stringify(o);
      op.textContent = `${o.label} — $${Number(o.price||0).toFixed(2)}`;
      optSel.appendChild(op);
    });

    // REQUIRED meal radios if mealChoices exist — NO default checked
    if (Array.isArray(b.mealChoices) && b.mealChoices.length){
      const meal = div.querySelector('.meal');
      meal.innerHTML = `
        <div style="margin:.5rem 0 .25rem;font-weight:600;">Meal Preference *</div>
        ${b.mealChoices.map(m=>`
          <label style="margin-right:10px">
            <input type="radio" name="meal-${b.id}" value="${m}"> ${m}
          </label>
        `).join('')}
      `;
    }

    // NOTES (optional only — no dietary checklist)
    const notes = div.querySelector('.notes');
    notes.innerHTML = `
      <div style="margin:.5rem 0 .25rem;font-weight:600;">Notes (optional)</div>
      <input class="other" placeholder="Allergies or other notes">
    `;

    // Attendee selector + enable Add button only when chosen
    const assign = div.querySelector('.assign');
    const attendeeSel = attendeeSelect();
    assign.appendChild(attendeeSel);

    const addBtn = div.querySelector('.add');
    const toggleAddBtn = () => {
      addBtn.disabled = !(attendeeSel && attendeeSel.value);
    };
    attendeeSel.addEventListener('change', toggleAddBtn);
    toggleAddBtn();

    // Add to cart — enforce attendee, meal (if any), and uniqueness for attendee+banquet
    addBtn.onclick = ()=>{
      // 1) Attendee required (button should already be disabled otherwise)
      if (!attendeeSel || !attendeeSel.value){
        alert('Please select an attendee first.');
        return;
      }

      // 2) Meal required if choices exist
      let mealChoice = '';
      const mealRadios = div.querySelectorAll(`input[name="meal-${b.id}"]`);
      if (mealRadios && mealRadios.length){
        const checked = [...mealRadios].find(r => r.checked);
        if (!checked){
          alert('Please choose a meal preference.');
          return;
        }
        mealChoice = checked.value;
      }

      // 3) Prevent double-adding same banquet for the same attendee
      const st = Cart.get();
      const attendeeId = attendeeSel.value;
      const alreadyHasThisBanquet = (st.lines || []).some(l =>
        l.attendeeId === attendeeId &&
        l.itemType === 'banquet' &&
        String(l.itemId).startsWith(b.id + ':')
      );
      if (alreadyHasThisBanquet){
        alert('This attendee is already assigned to this banquet.');
        return;
      }

      // Proceed to add
      const chosen = JSON.parse(optSel.value);
      const other  = div.querySelector('.notes .other')?.value || '';

      Cart.addLine({
        attendeeId,
        itemType: 'banquet',
        itemId: b.id + ":" + chosen.id,
        // No "Ticket" wording in the name — just event + (meal)
        itemName: `${b.name}${mealChoice ? ` (${mealChoice})` : ''}`,
        qty: 1,
        unitPrice: Number(chosen.price || 0), // dollars
        meta: {
          mealChoice,
          notes: other,
          event: b.datetime || "",
          location: b.location || ""
        }
      });

      alert('Banquet added');
    };

    wrap.appendChild(div);
  }

  // --- Scheduling + cap to 12 ---
  function isWithinWindow(b, now){
    const start = b.publishStart ? new Date(b.publishStart) : null;
    const end   = b.publishEnd   ? new Date(b.publishEnd)   : null;
    return (!start || now >= start) && (!end || now <= end);
  }

  const now = new Date();
  const MAX_BANQUETS = 12;

  const toRender = (window.BANQUETS || [])
    .filter(b => b.active !== false)     // manual override
    .filter(b => isWithinWindow(b, now)) // date window
    .slice(0, MAX_BANQUETS);             // show up to 12

  toRender.forEach(addBanquet);
});
</script>


  <style>
    .att-form input{margin:4px;padding:6px}
    .att-card{display:flex;gap:8px;align-items:center;justify-content:space-between;background:rgba(255,255,255,0.78);border:1px solid rgba(0,0,0,0.06);border-radius:10px;padding:8px;margin:6px 0}
    .banquet-card{background:rgba(255,255,255,0.78);border:1px solid rgba(0,0,0,0.06);border-radius:10px;padding:12px;margin:10px 0}
  </style>

  <!-- Core site scripts (order matters) -->
  <script src="assets/js/site-settings.js"></script>
  <script src="assets/js/items.js"></script>
  <script src="assets/js/banquets.js"></script>
  <script src="assets/js/cart.js"></script>
  <script src="assets/js/data-store.js"></script>
  <script src="assets/js/site-boot.js"></script>
</body>
</html>
