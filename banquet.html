<script>
  // ... keep the helpers above (money, normalizePrice, looksLikeEmail, etc.) ...

  document.addEventListener('DOMContentLoaded', function(){
    Cart.load();

    // --- existing attendee UI code stays the same ---

    // ===== Banquets UI =====
    const wrap = document.getElementById('banquets');

    function attendeeSelect(){
      const s = document.createElement('select');
      populateSelectWithAttendees(s);
      return s;
    }

    function addBanquet(b){
      if (b.active === false) return;

      const div = document.createElement('div');
      div.className = 'banquet-card';
      div.innerHTML = `
        <h3>${b.name}</h3>
        <div><small>${b.datetime || ''}</small></div>
        ${b.location ? `<div><small><em>${b.location}</em></small></div>` : ``}
        <p>${b.description || ''}</p>
        <label>Ticket:
          <select class="opt"></select>
        </label>
        <div class="meal"></div>
        <div class="assign"></div>
        <button class="add" disabled>Add to Order</button>
      `;

      const optSel = div.querySelector('.opt');
      (b.options || []).forEach(o=>{
        const price = normalizePrice(o.price);
        const payload = {...o, price};
        const op = document.createElement('option');
        op.value = JSON.stringify(payload);
        op.textContent = `${o.label} â€” ${money(price)}`;
        optSel.appendChild(op);
      });

      if (Array.isArray(b.mealChoices) && b.mealChoices.length){
        const meal = div.querySelector('.meal');
        meal.innerHTML = `
          <div style="margin:.5rem 0 .25rem;font-weight:600;">Meal Preference *</div>
          ${b.mealChoices.map(m=>`
            <label style="margin-right:10px">
              <input type="radio" name="meal-${b.id}" value="${m}"> ${m}
            </label>
          `).join('')}
        `;
      }

      const assign = div.querySelector('.assign');
      const attendeeSel = attendeeSelect();
      assign.appendChild(attendeeSel);

      const addBtn = div.querySelector('.add');
      const toggleAddBtn = () => { addBtn.disabled = !(attendeeSel && attendeeSel.value); };
      attendeeSel.addEventListener('change', toggleAddBtn);
      toggleAddBtn();

      addBtn.onclick = ()=>{
        if (!attendeeSel || !attendeeSel.value){ alert('Please select an attendee first.'); return; }

        let mealChoice = '';
        const mealRadios = div.querySelectorAll(`input[name="meal-${b.id}"]`);
        if (mealRadios && mealRadios.length){
          const checked = [...mealRadios].find(r => r.checked);
          if (!checked){ alert('Please choose a meal preference.'); return; }
          mealChoice = checked.value;
        }

        const st = Cart.get();
        const attendeeId = attendeeSel.value;
        const att = (st.attendees||[]).find(x=>x.id===attendeeId);
        const attendeeNotes = (att && att.notes) ? String(att.notes) : '';

        const dup = (st.lines || []).some(l =>
          l.attendeeId === attendeeId &&
          l.itemType === 'banquet' &&
          String(l.itemId).startsWith(b.id + ':')
        );
        if (dup){ alert('This attendee is already assigned to this banquet.'); return; }

        const chosen = JSON.parse(optSel.value);
        const unitPrice = normalizePrice(chosen.price);

        Cart.addLine({
          attendeeId,
          itemType: 'banquet',
          itemId: b.id + ":" + chosen.id,
          itemName: `${b.name}${mealChoice ? ` (${mealChoice})` : ''}`,
          qty: 1,
          unitPrice,
          meta: { mealChoice, attendeeNotes, event: b.datetime || "", location: b.location || "" }
        });

        try { localStorage.setItem('amaranth_cart_ping', String(Date.now())); } catch(e) {}
        alert('Banquet added');
      };

      wrap.appendChild(div);
    }

    // Use server banquets first; fall back to static list
    async function loadBanquets() {
      // Helper: publish-window check (compare as timestamps)
      function isWithinWindow(b, nowTs){
        const s = b.publishStart ? Date.parse(b.publishStart) : null;
        const e = b.publishEnd   ? Date.parse(b.publishEnd)   : null;
        return (s == null || nowTs >= s) && (e == null || nowTs <= e);
      }

      const nowTs = Date.now();
      let list = [];

      try {
        const r = await fetch('/api/router?type=banquets', { cache: 'no-store' });
        if (r.ok) {
          const j = await r.json();
          if (Array.isArray(j?.banquets)) list = j.banquets;
        }
      } catch (e) {
        console.warn('Server banquets fetch failed:', e);
      }

      if (!list.length && Array.isArray(window.BANQUETS)) {
        // fallback to static file
        list = window.BANQUETS;
      }

      // Filter by active + publish window
      list
        .filter(b => b.active !== false)
        .filter(b => isWithinWindow(b, nowTs))
        .forEach(addBanquet);
    }

    loadBanquets();
  });
</script>